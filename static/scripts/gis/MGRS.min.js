OpenLayers.Control.MGRSMousePosition=OpenLayers.Class(OpenLayers.Control,{element:null,prefix:"",separator:", ",suffix:"",numDigits:5,granularity:10,lastXy:null,displayProjection:null,initialize:function(b){OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.map&&this.map.events.unregister("mousemove",this,this.redraw);OpenLayers.Control.prototype.destroy.apply(this,arguments)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this.element||
(this.div.left="",this.div.top="",this.element=this.div);this.redraw();return this.div},redraw:function(b){if(null==b)var g=new OpenLayers.LonLat(0,0);else{if(null==this.lastXy||Math.abs(b.xy.x-this.lastXy.x)>this.granularity||Math.abs(b.xy.y-this.lastXy.y)>this.granularity){this.lastXy=b.xy;return}g=this.map.getLonLatFromPixel(b.xy);if(!g)return;this.displayProjection&&g.transform(this.map.getProjectionObject(),this.displayProjection);this.lastXy=b.xy}b=this.formatOutput(g);b!=this.element.innerHTML&&
(this.element.innerHTML=b)},formatOutput:function(b){var g=OpenLayers.INCHES_PER_UNIT;g=this.map.getResolution()*g[this.map.getUnits()]*(1/g.m);var t=parseInt(6-Math.ceil(Math.log(g)/2.302585092994046));g=parseInt(this.numDigits);var u=new USNG2;t=-80<b.lat&&80>b.lat?u.fromLonLat(b,t-1):"undefined";return this.prefix+b.lon.toFixed(g)+this.separator+b.lat.toFixed(g)+" / MGRS: "+t+this.suffix},setMap:function(){OpenLayers.Control.prototype.setMap.apply(this,arguments);this.map.events.register("mousemove",
this,this.redraw)},CLASS_NAME:"OpenLayers.Control.MousePosition"});
function USNG2(){var b="ABCDEFGHJKLMNPQRSTUV".split(""),g="FGHJKLMNPQRSTUVABCDE".split(""),t="ABCDEFGH".split(""),u="JKLMNPQR".split(""),w="STUVWXYZ".split(""),v="CDEFGHJKLMNPQRSTUVWX".split(""),D=[-80,-72,-64,-56,-48,-40,-32,-24,-16,-8,0,8,16,24,32,40,48,58,64,72],C=Array(20);for(i=0;20>i;i++)C[i]=110946.259*D[i];this.llDistance=function(a,h){lat_s=a.lat*Math.PI/180;lat_f=h.lat*Math.PI/180;d_lon=(h.lon-a.lon)*Math.PI/180;return Math.atan2(Math.sqrt(Math.pow(Math.cos(lat_f)*Math.sin(d_lon),2)+Math.pow(Math.cos(lat_s)*
Math.sin(lat_f)-Math.sin(lat_s)*Math.cos(lat_f)*Math.cos(d_lon),2)),Math.sin(lat_s)*Math.sin(lat_f)+Math.cos(lat_s)*Math.cos(lat_f)*Math.cos(d_lon))};this.fromUTM=function(a,h,f,q,k){grid_square_set=a%6;ew_idx=Math.floor(f/1E5)-1;ns_idx=Math.floor(q%2E6/1E5);switch(grid_square_set){case 1:var l=t[ew_idx]+b[ns_idx];break;case 2:l=u[ew_idx]+g[ns_idx];break;case 3:l=w[ew_idx]+b[ns_idx];break;case 4:l=t[ew_idx]+g[ns_idx];break;case 5:l=u[ew_idx]+b[ns_idx];break;case 0:l=w[ew_idx]+g[ns_idx];break;default:throw"USNG: can't get here";
}for(var d=Math.floor(f%1E5).toString(),c=Math.floor(q%1E5).toString();5>d.length;)d="0"+d;for(;5>c.length;)c="0"+c;5<k?(digits=k-5,f=d+(f%1).toFixed(digits).substr(2,digits),q=c+(q%1).toFixed(digits).substr(2,digits)):(f=d.substr(0,k),q=c.substr(0,k));return usng_string=String(a)+h+l+f+q};this.toUTMFromFullParsedUSNG=function(a,h,f,q,k,l){switch(a%6){case 1:var d=b;var c=t;break;case 2:d=g;c=u;break;case 3:d=b;c=w;break;case 4:d=g;c=t;break;case 5:d=b;c=u;break;case 0:d=g;c=w;break;default:throw"Can't get here";
}ew_idx=c.indexOf(f[0]);ns_idx=d.indexOf(f[1]);if(-1==ew_idx||-1==ns_idx)throw"USNG: Invalid USNG 100km grid designator.";f=1E5*(ew_idx+1)+q;k=1E5*(ns_idx+0)+k;min_northing=C[v.indexOf(h)];k+=2E6*Math.ceil((min_northing-k)/2E6);ll=utm_proj.invProj(a,f,k);ll_utm_zone=Math.floor((ll.lon- -180)/6)+1;ll_grid_zone=v[Math.floor((ll.lat- -80)/8)];ll_grid_zone!=h&&(k-=2E6,ll=utm_proj.invProj(a,f,k),ll_utm_zone=Math.floor((ll.lon- -180)/6)+1,ll_grid_zone=v[Math.floor((ll.lat- -80)/8)]);if(ll_utm_zone!=a||
ll_grid_zone!=h)throw"USNG: calculated coordinate not in correct UTM or grid zone! Supplied: "+a+h+" Calculated: "+ll_utm_zone+ll_grid_zone;return{zone:a,easting:f,northing:k,precision:l}};this.toUTM=function(a,h){var f=0,q=0,k=0,l=null,d=null,c=null,e=null;a=a.replace(/ /g,"");re=/([0-9]+)$/;if(fields=re.exec(a))l=fields[0],k=l.length/2,scale_factor=Math.pow(10,5-k),f=Number(l.substr(0,k))*scale_factor,q=Number(l.substr(k,k))*scale_factor;a=a.substr(0,a.length-2*k);re=/([A-Z][A-Z]$)/;(fields=re.exec(a))&&
(d=fields[0]);a=a.substr(0,a.length-2);re=/([0-9]+)([A-Z])/;if(fields=re.exec(a))e=fields[1],c=fields[2];if(!(e&&c&&d))if(d&&h){a=1E3;var m=null,n=null;B=Math.floor((h.lon- -180)/6)+1;for(e=B-1;e<=B+1;e++)for(grid_zone_idx=0;20>grid_zone_idx;grid_zone_idx++){c=v[grid_zone_idx];try{result=this.toLonLat(e%60+c+d+l),arc_distance=this.llDistance(h,result),arc_distance<a&&(a=arc_distance,m=e%60,n=c)}catch(E){}}if(m&&n)e=m,c=n;else throw"USNG: Couldn't find a match";}else if(h){a=1E3;var p=n=m=null,B=Math.floor((h.lon-
-180)/6)+1,r=Math.floor((h.lat- -80)/8);for(e=B-1;e<=B+1;e++)for(grid_zone_idx=r-1;grid_zone_idx<=r+1;grid_zone_idx++){c=v[grid_zone_idx];switch(e%6){case 1:var z=b;var A=t;break;case 2:z=g;A=u;break;case 3:z=b;A=w;break;case 4:z=g;A=t;break;case 5:z=b;A=u;break;case 0:z=g;A=w;break;default:throw"Can't get here";}for(ns_idx=0;20>ns_idx;ns_idx++)for(ew_idx=0;8>ew_idx;ew_idx++)try{d=A[ew_idx]+z[ns_idx],result=this.toLonLat(e%60+c+d+l),arc_distance=this.llDistance(h,result),arc_distance<a&&(a=arc_distance,
m=e%60,n=c,p=d)}catch(E){}}if(m&&n)e=m,c=n,d=p;else throw"USNG: Couldn't find a match";}else throw"USNG: Not enough information to locate point.";return this.toUTMFromFullParsedUSNG(e,c,d,f,q,k)};this.fromLonLat=function(a,h){usng_string=new String;for(var f=a.lon,b=a.lat;-180>f;)f+=180;for(;180<f;)f-=180;utm_zone=Math.floor((f- -180)/6)+1;if(!(-80<b&&80>b))throw"USNG: Latitude must be between -80 and 80. (Zones A and B are not implemented yet.)";a=v[Math.floor((b- -80)/8)];f=utm_proj.proj(utm_zone,
f,b);return this.fromUTM(utm_zone,a,f.utm_easting,f.utm_northing,h)};this.toLonLat=function(a,b){result=this.toUTM(a,b);ll=utm_proj.invProj(result.zone,result.easting,result.northing);ll.precision=result.precision;return ll};this.UTM=function(){var a=(40680631590769-6356752.3*6356752.3)/40680631590769,b=a/(1-a),f=a*a,g=a*f,k=Math.PI/180;this.proj=function(l,d,c){var e=c*k,m=Math.sin(e),n=Math.cos(e);c=m/n;var p=c*c,h=p*p;m=6378137/Math.sqrt(1-a*m*m);var r=b*n*n;d=n*(d*k- -(6*(30-l)+3)*k);e=6378137*
(1-a/4-3*f/64-5*g/256)*e+-6378137*(3*a/8+3*f/32+45*g/1024)*Math.sin(2*e)+6378137*(15*f/256+45*g/1024)*Math.sin(4*e)+-223234795*g/3072*Math.sin(6*e);n=Math.pow(d,5);x=.9996*m*(d+(1-p+r)*Math.pow(d,3)/6+(5-18*p+h+72*r-58*b)*n/120)+5E5;y=.9996*(e+m*c*(d*d/2+(5-p+9*r+4*r*r)*Math.pow(d,4)/24+n*d/720*(61-58*p+h+600*r-330*b)));return{utm_zone:l,utm_easting:x,utm_northing:y}};this.invProj=function(h,d,c){h=-(6*(30-h)+3)*k;var e=Math.sqrt(1-a);e=(1-e)/(1+e);var m=e*e,n=e*m;c=c/.9996/(6378137*(1-a/4-f/64*3-
g/256*5));c=c+(1.5*e-.84375*n)*Math.sin(2*c)+(1.3125*m-1.71875*m*m)*Math.sin(4*c)+151*n/96*Math.sin(6*c);var p=Math.sin(c);e=Math.cos(c);m=p/e;n=6378137/Math.sqrt(1-a*p*p);var l=m*m,r=b*e*e;p=1-a*p*p;p=6378137*(1-a)/Math.sqrt(p*p*p);d=(d-5E5)/(.9996*n);var q=d*d,t=d*q,u=q*q,w=l*l,v=r*r;temp2=5+3*l+10*r-4*v-9*b;temp4=61+90*l+298*r+45*w-252*b-3*v;temp5=(1+2*l+r)*t/6;temp6=5-2*r+28*l-3*v+8*b+24*w;lat=180*(c-n*m/p*(q/2-u/24*temp2+temp4*t*t/720))/Math.PI;lon=180*(h+(d-temp5+temp6*d*u/120)/e)/Math.PI;return{lon:lon,
lat:lat}}};utm_proj=new this.UTM};
