Ext.namespace("gxp.plugins");
gxp.plugins.WMSGetFeatureInfo=Ext.extend(gxp.plugins.Tool,{ptype:"gxp_wmsgetfeatureinfo",outputTarget:"map",popupCache:null,infoActionTip:"Get Feature Info",popupTitle:"Feature Info",buttonText:"Identify",format:"html",addActions:function(){this.popupCache={};var d=gxp.plugins.WMSGetFeatureInfo.superclass.addActions.call(this,[{tooltip:this.infoActionTip,iconCls:"gxp-icon-getfeatureinfo",buttonText:this.buttonText,toggleGroup:this.toggleGroup,enableToggle:!0,allowDepress:!0,toggleHandler:function(b,
d){b=0;for(var e=c.controls.length;b<e;b++)d?c.controls[b].activate():c.controls[b].deactivate()}}]),h=this.actions[0].items[0],c={controls:[]},a=function(){for(var b=this.target.mapPanel.layers.queryBy(function(b){return b.get("queryable")}),d=this.target.mapPanel.map,e,a=0,k=c.controls.length;a<k;a++)e=c.controls[a],e.deactivate(),e.destroy();c.controls=[];b.each(function(b){var a=b.getLayer(),e=Ext.apply({},this.vendorParams);if(this.layerParams)for(var f=this.layerParams.length-1;0<=f;--f){var k=
this.layerParams[f].toUpperCase();e[k]=a.params[k]}var g=b.get("infoFormat");void 0===g&&(g="html"==this.format?"text/html":"application/vnd.ogc.gml");a=new OpenLayers.Control.WMSGetFeatureInfo(Ext.applyIf({url:a.url,queryVisible:!0,layers:[a],infoFormat:g,vendorParams:e,eventListeners:{getfeatureinfo:function(a){var c=b.get("title")||b.get("name");if("text/html"==g){var d=a.text.match(/<body[^>]*>([\s\S]*)<\/body>/);d&&!d[1].match(/^\s*$/)&&this.displayPopup(a,c,d[1])}else"text/plain"==g?this.displayPopup(a,
c,"<pre>"+a.text+"</pre>"):a.features&&0<a.features.length&&this.displayPopup(a,c,null,b.get("getFeatureInfo"))},scope:this}},this.controlOptions));d.addControl(a);c.controls.push(a);h.pressed&&a.activate()},this)};this.target.mapPanel.layers.on("update",a,this);this.target.mapPanel.layers.on("add",a,this);this.target.mapPanel.layers.on("remove",a,this);return d},displayPopup:function(d,h,c,a){var b=d.xy.x+"."+d.xy.y;a=a||{};if(b in this.popupCache)var f=this.popupCache[b];else f=this.addOutput({xtype:"gx_popup",
title:this.popupTitle,layout:"accordion",fill:!1,autoScroll:!0,location:d.xy,map:this.target.mapPanel,width:250,height:300,defaults:{layout:"fit",autoScroll:!0,autoHeight:!0,autoWidth:!0,collapsible:!0}}),f.on({close:function(a){return function(b){delete this.popupCache[a]}}(b),scope:this}),this.popupCache[b]=f;d=d.features;b=[];if(!c&&d)for(var e=0,l=d.length;e<l;++e)c=d[e],b.push(Ext.apply({xtype:"gxp_editorgrid",readOnly:!0,listeners:{beforeedit:function(a){return!1}},title:c.fid?c.fid:h,feature:c,
fields:a.fields,propertyNames:a.propertyNames},this.itemConfig));else c&&b.push(Ext.apply({title:h,html:c},this.itemConfig));f.add(b);f.doLayout()}});Ext.preg(gxp.plugins.WMSGetFeatureInfo.prototype.ptype,gxp.plugins.WMSGetFeatureInfo);
