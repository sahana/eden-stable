/*
 2015-2020 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery jstree 3.0.3
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,l,g){b instanceof String&&(b=String(b));for(var e=b.length,f=0;f<e;f++){var h=b[f];if(l.call(g,h,f,b))return{i:f,v:h}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,l,g){if(b==Array.prototype||b==Object.prototype)return b;b[l]=g.value;return b};$jscomp.getGlobal=function(b){b=["object"==typeof globalThis&&globalThis,b,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var l=0;l<b.length;++l){var g=b[l];if(g&&g.Math==Math)return g}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(b,l){var g=$jscomp.propertyToPolyfillSymbol[l];if(null==g)return b[l];g=b[g];return void 0!==g?g:b[l]};
$jscomp.polyfill=function(b,l,g,e){l&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(b,l,g,e):$jscomp.polyfillUnisolated(b,l,g,e))};$jscomp.polyfillUnisolated=function(b,l,g,e){g=$jscomp.global;b=b.split(".");for(e=0;e<b.length-1;e++){var f=b[e];f in g||(g[f]={});g=g[f]}b=b[b.length-1];e=g[b];l=l(e);l!=e&&null!=l&&$jscomp.defineProperty(g,b,{configurable:!0,writable:!0,value:l})};
$jscomp.polyfillIsolated=function(b,l,g,e){var f=b.split(".");b=1===f.length;e=f[0];e=!b&&e in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var h=0;h<f.length-1;h++){var c=f[h];c in e||(e[c]={});e=e[c]}f=f[f.length-1];g=$jscomp.IS_SYMBOL_NATIVE&&"es6"===g?e[f]:null;l=l(g);null!=l&&(b?$jscomp.defineProperty($jscomp.polyfills,f,{configurable:!0,writable:!0,value:l}):l!==g&&($jscomp.propertyToPolyfillSymbol[f]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(f):$jscomp.POLYFILL_PREFIX+f,f=$jscomp.propertyToPolyfillSymbol[f],
$jscomp.defineProperty(e,f,{configurable:!0,writable:!0,value:l})))};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,g){return $jscomp.findInternal(this,b,g).v}},"es6","es3");
(function(b,l){var g=0,e={},f={},h={};b.widget("s3.locationselector",{options:{hideLx:!0,reverseLx:!1,locations:null,labels:null,minBBOX:.05,showLabels:!0,featureRequired:null,latlonMode:"decimal",latlonModeToggle:!0,openMapOnLoad:!1},_create:function(){this.id=g;g+=1;this.eventNamespace=".locationselector"},_init:function(){var c=b(this.element),a=this.options,d=c.attr("id");if(!d)throw"Location selector widget: real input field without id";this.fieldname=d;this.input=c;this.data=null;this._storeHierarchyData(a.labels,
a.locations);this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();var c=this._deserialize();this._renderWidget();var a="#"+this.fieldname,d=this.options;b(a+"_geocode button").length?this.useGeocoder=!0:this.useGeocoder=!1;var n=b(a+"_L0__row");if(n.length){var p=[];for(g in e){var m=e[g];0===m.l&&(m.i=g,p.push(m))}p.sort(function(a,c){return a.n.localeCompare(c.n)});for(var k=b(a+"_L0"),f=0,h=p.length;f<h;f++){m=p[f];var g=m.i;m='<option value="'+
g+'">'+m.n+"</option>";k.append(m)}n.removeClass("hide").show();n=b(a+"_L0__row1");n.length&&n.removeClass("hide").show()}n=c.L0;p=c.L1;k=c.L2;f=c.L3;h=c.L4;m=c.L5;n&&this._lxSelect(0,n,!0);(p||k)&&this._lxSelect(1,p||k,!0);(k||f)&&this._lxSelect(2,k||f,!0);(f||h)&&this._lxSelect(3,f||h,!0);(h||m)&&this._lxSelect(4,h||m,!0);m&&this._lxSelect(5,m,!0);this.lx=[n,p,k,f,h,m].join("|");b(a+"_address").val(c.address);b(a+"_address__row").removeClass("hide").show();b(a+"_address__row1").removeClass("hide").show();
b(a+"_postcode").val(c.postcode);b(a+"_postcode__row").removeClass("hide").show();b(a+"_postcode__row1").removeClass("hide").show();b(a+"_lat").val(c.lat).latloninput({type:"lat",mode:d.latlonMode});b(a+"_lat__row").removeClass("hide").show();b(a+"_lat__row1").removeClass("hide").show();b(a+"_lon").val(c.lon).latloninput({type:"lon",mode:d.latlonMode});b(a+"_lon__row").removeClass("hide").show();b(a+"_lon__row1").removeClass("hide").show();n=b(a+"_map_icon__row").removeClass("hide").show();c.lat||
c.lon||c.wkt?(this.input.data("manually_geocoded",!0),this._showMap()):d.featureRequired?this._showMap():d.openMapOnLoad&&n.is(":visible")&&"#sub_"!=a.substring(0,5)?this._showMap():this._hideMap();this.input.data("input",this._hasData());this.input.prevAll(".throbber").remove();this._bindEvents()},_renderWidget:function(){var c=this.fieldname,a="#"+c,d=this.options.reverseLx,n=b(a+"_map_icon__row .map_wrapper");n.attr("id",this.fieldname+"_map_wrapper");var e=b(a+"__row"),f=this.input.next(".error_wrapper"),
k=b(a+"_map_icon__row"),h=b(a+"_L0__row"),g=b(a+"_postcode__row");if(e.is(".control-group, .form-row")){c=b(a+"_L1__row");var l=b(a+"_L2__row"),r=b(a+"_L3__row"),A=b(a+"_L4__row"),t=b(a+"_L5__row"),q=b(a+"_address__row"),x=b(a+"_lat__row"),u=b(a+"_lon__row");a=b(a+"_latlon_toggle__row");d?e.hide().after(n).after(k).after(a).after(u).after(x).after(h).after(c).after(l).after(r).after(A).after(t).after(g).after(q).after(f):e.hide().after(n).after(k).after(a).after(u).after(x).after(g).after(q).after(t).after(A).after(r).after(l).after(c).after(h).after(f)}else e.parent().is(".inline-form")?
e.show():(b(a+"__row1").hide(),e.hide().after(f),k.detach(),e.siblings('[id^="'+c+'"][id$="__row"]').last().after(n).after(k));if(f.length)f.one("click"+this.eventNamespace,function(){var a=b(this);a.fadeOut("slow",function(){a.remove()})})},_lxSelectFinal:function(c){c?this._serialize():this._collectData();this._zoomMap()},_lxSelect:function(c,a,d){var n="#"+this.fieldname,p=this.options,m=b(n+"_L"+c),k;a?(m.val(a).trigger("change","implicit"),m.hasClass("multiselect")&&m.multiselect("instance")&&
m.multiselect("refresh")):a=parseInt(m.val(),10);if(0===c){var h=this._readLabels(a),g=f.d,l=["1","2","3","4","5"],r,A,t;h.then(function(a){for(t=0;5>t;t++)k=l[t],r=a[k]||g[k],q=n+"_L"+k,m=b(q),A=p.showLabels?m.hasClass("required")?"<div>"+r+':<span class="req"> *</span></div>':r+":":"",b(q+"__row label").html(A),b(q+"__row1 label").html(A),b(q+' option[value=""]').html(i18n.select+" "+r),m.hasClass("multiselect")&&m.multiselect("instance")&&m.multiselect("refresh")})}h=p.hideLx;for(k=c+1;6>k;k++){var q=
n+"_L"+k;h?(b(q+"__row").hide(),b(q+"__row1").hide()):b(q+" option").remove('[value != ""]');b(q).val("").trigger("change","implicit")}if(a){var x=!1,u=c+1,B=b(n+"_L"+u+"__row");B.length||(x=!0,u++,B=b(n+"_L"+u+"__row"));if(B.length){var v;h=!1;var C=this;if(b(n+"_L"+c+' option[value="'+a+'"]').hasClass("missing")){var w=e[a];w.i=a;var y=[w]}else for(v in y=[],h=!0,e)if(e[v].f==a){h=!1;break}this._readHierarchy(h,a,u,x).then(function(){if(0==y.length)for(v in e)w=e[v],w.f==a&&(w.i=v,y.push(w));var c=
y.length;if(c){y.sort(function(a,c){return a.n.localeCompare(c.n)});var f=n+"_L"+u;var k=b(f),h=b(f+' option[value=""]').html();b(f+" option").remove('[value != ""]');v=null;for(t=0;t<c;t++)w=y[t],v=w.i,f=a==v?' selected="selected"':"",x=w.l==u?"":' class="missing"',f='<option value="'+v+'"'+f+x+">"+w.n+"</option>",k.append(f);B.removeClass("hide").show();b(n+"_L"+u+"__row1").removeClass("hide").show();k.hasClass("multiselect")&&(h={header:"",height:300,minWidth:0,selectedList:1,noneSelectedText:h,
multiple:!1},k.hasClass("search")?(k.multiselect(h).multiselectfilter({label:"",placeholder:i18n.search}),b(".ui-multiselect-header").show()):(h.header=!1,k.multiselect(h)));k=C.data["L"+u];h=y.map(function(a){return a.i});k&&-1!=h.indexOf(""+k)?C._lxSelect(u,k,d):1==c&&v&&C._lxSelect(u,v,d)}C._lxSelectFinal(d)})}else this.useGeocoder&&!d&&this._geocodeDecision(),this._lxSelectFinal(d)}else this._lxSelectFinal(d)},_collectData:function(c){var a=this.data,d="#"+this.fieldname,n=this._lookupParent(),
e=b(d+"_address").val(),f=b(d+"_postcode").val();a.address=e;a.postcode=f;if(a.specific)a.id=a.specific,a.parent=n;else{var k=a.lat,h=a.lon,g=a.wkt;e||f||k||h||g?(a.id=null,a.parent=n):(a.id=n,a.parent=null)}this._serialize();b(d+"_lat").val(a.lat).trigger("setvalue");b(d+"_lon").val(a.lon).trigger("setvalue");this.input.data("input",this._hasData());"sub_"==this.fieldname.slice(0,4)&&this.input.trigger("change",c&&"user"||"implicit")},_collectLx:function(){var c=this.data,a="#"+this.fieldname,d;
for(d=0;6>d;d++){var e=b(a+"_L"+d);e.length&&(e=e.val(),c["L"+d]=e?parseInt(e,10):null)}this._serialize()},_hasData:function(){var c=this.data,a=!1;c.specific||c.address||c.postcode||c.lat||c.lon||c.wkt?a=!0:[c.L0,c.L1,c.L2,c.L3,c.L4,c.L5].join("|")!=this.lx&&(a=!0);return a},_lookupParent:function(){this._collectLx();for(var c=this.data,a,b=5;-1<b;b--)if(a=c["L"+b])return a;return(c=e.d)?c.i:null},_readLabels:function(c){c||(c="d");var a=b.Deferred(),d=f[c];if(d==l){var e=S3.Ap.concat("/gis/hdata/"+
c);b.ajaxS3({url:e,dataType:"json",success:function(b){d={};try{for(var e in b)d[e]=b[e];f[c]=d}catch(k){}a.resolve(d)},error:function(c,b,d){(c="UNAUTHORIZED"==d?i18n.gis_requires_login:c.responseText)&&s3_debug(c);a.reject()}})}else a.resolve(d);return a.promise()},_readHierarchy:function(c,a,d,f){var n=""+a+";"+d+";"+f,m=h[n];if(m!==l)return m;var k=b.Deferred();if(c){c="#"+this.fieldname;var g=b(c+"_L"+d),D=!1;g.hide();if(g.hasClass("multiselect")){D=!0;var z=b(c+"_L"+d+"__row button").hide()}var r=
b(c+"_L"+d+"__throbber").removeClass("hide").show();a=f?S3.Ap.concat("/gis/ldata/"+a+"/"+d):S3.Ap.concat("/gis/ldata/"+a);b.ajaxS3({url:a,dataType:"json",success:function(a){for(var c in a)e[c]=a[c];r.hide();D?z.removeClass("hide").show():g.removeClass("hide").show();k.resolve()},error:function(a,c,b){if(a="UNAUTHORIZED"==b?i18n.gis_requires_login:a.responseText)s3_debug(a),S3.showAlert(a,"error");r.hide();D?z.removeClass("hide").show():g.removeClass("hide").show();k.reject()}})}else k.resolve();
return m=h[n]=k.promise()},_geocodeDecision:function(){var c="#"+this.fieldname,a=this.data;this._collectData();if(a.address){a=["1","2","3","4","5"];for(var d=0,e;5>d;d++)if(e=b(c+"_L"+a[d]),e.length&&!e.val()&&1<e[0].options.length)return;b(c+"_geocode .geocode_success,"+c+"_geocode .geocode_fail").hide();var f=this;a=this.eventNamespace;this.input.data("manually_geocoded")?b(c+"_geocode button").removeClass("hide").show().unbind(a).bind("click"+a,function(){b(this).hide();f._geocode()}):this._geocode()}},
_geocode:function(){var c=this.fieldname,a=this,d="#"+c,e=b(d+"_geocode .geocode_fail").hide(),f=b(d+"_geocode .geocode_success").hide(),h=b(d+"_geocode .throbber").removeClass("hide").show(),k=this.data;d={address:k.address};for(var g="postcode L0 L1 L2 L3 L4 L5".split(" "),l=0,z,r;7>l;l++)z=g[l],(r=k[z])&&(d[z]=r);g=S3.Ap.concat("/gis/geocode");b.ajaxS3({url:g,type:"POST",data:d,dataType:"json",success:function(b){var d=b.lat,n=b.lon;if(d||n){k.lat=parseFloat(d);k.lon=parseFloat(n);a._collectData();
d=S3.gis;if(d.maps&&(n=d.maps["location_selector_"+c])){b=n.s3.draftLayer;b.removeAllFeatures();var m=new OpenLayers.Geometry.Point(k.lon,k.lat);m.transform(d.proj4326,n.getProjectionObject());d=new OpenLayers.Feature.Vector(m);b.addFeatures([d]);a._zoomMap()}h.hide();f.html(i18n.address_mapped).removeClass("hide").show()}else h.hide(),e.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(b)},error:function(a,c,b){a="UNAUTHORIZED"==b?i18n.gis_requires_login:a.responseText;h.hide();e.html(i18n.address_not_mapped).removeClass("hide").show();
s3_debug(a)}})},_geocodeReverse:function(){var c=this,a="#"+this.fieldname,d=b(a+"_geocode .geocode_fail").hide(),e=b(a+"_geocode .geocode_success").hide(),f=b(a+"_geocode .throbber").removeClass("hide").show();a=this.data;a={lat:a.lat,lon:a.lon};var h=S3.Ap.concat("/gis/geocode_r");b.ajaxS3({async:!1,url:h,type:"POST",data:a,dataType:"json",success:function(a){a.L0?(c.useGeocoder=!1,c._lxSelect(0,a.L0),a.L1&&c._lxSelect(1,a.L1),a.L2&&c._lxSelect(2,a.L2),a.L3&&c._lxSelect(3,a.L3),a.L4&&c._lxSelect(4,
a.L4),a.L5&&c._lxSelect(5,a.L5),c.useGeocoder=!0,f.hide(),e.html(i18n.location_found).removeClass("hide").show()):(f.hide(),d.html(i18n.location_not_found).removeClass("hide").show())},error:function(a,c,b){a="UNAUTHORIZED"==b?i18n.gis_requires_login:a.responseText;f.hide();d.html(i18n.location_not_found).removeClass("hide").show();s3_debug(a)}})},_latlonInput:function(){var c=this.fieldname,a=this.data,d="#"+c,e=b(d+"_lat").val();d=b(d+"_lon").val();e||d?(e=e?parseFloat(e):0,d=d?parseFloat(d):0,
a.lat=e,a.lon=d,a.wkt=null,this.input.data("manually_geocoded",!0)):(a.lat=null,a.lon=null,a.wkt||this.input.data("manually_geocoded",!1));this._serialize();e=S3.gis;e.maps&&(c=e.maps["location_selector_"+c])&&(d=c.s3.draftLayer,d.removeAllFeatures(),null!==a.lat&&null!==a.lon&&(a=new OpenLayers.Geometry.Point(a.lon,a.lat),a.transform(e.proj4326,c.getProjectionObject()),a=new OpenLayers.Feature.Vector(a),d.addFeatures([a]),c.s3.lastDraftFeature=a),this._zoomMap())},_showMap:function(c){var a=this.fieldname,
d=this.eventNamespace,e=this,f="#"+a;b(f+"_map_icon").unbind(d).bind("click"+d,function(){e._hideMap()});b(f+"_map_icon span").html(i18n.hide_map);d=b(f+"_map_wrapper").hide().removeClass("hide").slideDown("medium");d.length&&c&&b("html,body").animate({scrollTop:d.offset().top},250);var h=this.input;b.when(this._jsLoaded()).then(function(){var c=S3.gis,d="location_selector_"+a;var n=c.maps[d]?c.maps[d]:c.show_map(d);e._zoomMap();var m=e.data;d=m.lat;var g=m.lon,p=m.wkt;if(d||g||p)n.s3.draftLayer.removeAllFeatures(),
p!=l&&p?(d={internalProjection:n.getProjectionObject(),externalProjection:c.proj4326},d=(new OpenLayers.Format.WKT(d)).read(p)):(d=new OpenLayers.Geometry.Point(parseFloat(g),parseFloat(d)),d.transform(c.proj4326,n.getProjectionObject()),d=new OpenLayers.Feature.Vector(d)),n.s3.draftLayer.addFeatures([d]),n.s3.lastDraftFeature=d;d=n.controls;g=0;for(var t=d.length;g<t;g++)if("OpenLayers.Control.DrawFeature"==d[g].CLASS_NAME){var q=d[g];break}q&&(n.s3.pointPlaced=function(d){b(f+"_geocode .geocode_fail").hide();
b(f+"_geocode .geocode_success").hide();var k=d.geometry;if("OpenLayers.Geometry.Point"==k.CLASS_NAME)d=k.getBounds().getCenterLonLat(),d.transform(n.getProjectionObject(),c.proj4326),m.wkt=null,m.lat=d.lat,m.lon=d.lon,!m.address&&e.useGeocoder&&e._geocodeReverse();else{k={internalProjection:n.getProjectionObject(),externalProjection:c.proj4326};m.radius=null;var g=new OpenLayers.Geometry.LinearRing(d.geometry.components[0].components);g=new OpenLayers.Geometry.Polygon([g]);if(1E3==g.getVertices().length){var l=
(new OpenLayers.Feature.Vector(g,null)).geometry.getBounds();g=l.right;var q=(l.bottom+l.top)/2;l=new OpenLayers.Geometry.Point((l.left+g)/2,q);g=new OpenLayers.Geometry.Point(g,q);g=new OpenLayers.Geometry.LineString([l,g]);g=parseFloat(g.getLength());m.radius=g}p=(new OpenLayers.Format.WKT(k)).write(d);m.wkt=p;m.lat=null;m.lon=null}h.data("manually_geocoded",!0);e._collectData(!0);e._removeErrors();"sub_"==a.substring(0,4)&&h.parent().find("div.map_wrapper").trigger("change")})},function(a){s3_debug(a)},
function(a){s3_debug(a)})},_hideMap:function(){var c=this.fieldname,a=this.eventNamespace,d="#"+c,e=this;b(d+"_map_icon").unbind(a).bind("click"+a,function(a){e._showMap(a)});b(d+"_map_wrapper").slideUp("medium");a=this.data;if(a.specific)var f=i18n.show_map_view;else if(f=i18n.show_map_add,S3.gis.maps&&(c=S3.gis.maps["location_selector_"+c]))c.s3.draftLayer.removeAllFeatures(),a.lat=null,a.lon=null,a.wkt=null,this.input.data("manually_geocoded",!1),this._collectData();b(d+"_map_icon span").html(f)},
_zoomMap:function(c){var a=this.fieldname,b=S3.gis;if(b.maps&&(a=b.maps["location_selector_"+a])){var f=this.data;b=f.lat;var h=f.lon;f=f.wkt;if(b&&h)b=OpenLayers.Bounds.fromArray([h,b,h,b]);else if(f)b=(new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(f))).geometry.getBounds();else{c||(c=this._lookupParent()||"d");b=e[c].b;if(!b||!b.length)for(h=e[c].f,c=4;h&&c&&(c--,h=e[h],!(b=h.b)&&0!==h.l);)h=h.f;b&&(b=OpenLayers.Bounds.fromArray(b))}b&&S3.gis.zoomBounds(a,b,this.options.minBBOX)}},_validate:function(){var c=
this.fieldname;this._removeErrors();c="#"+c;var a=this.data,d=this.options.featureRequired;if(d){var f=!1;switch(d){case "latlon":f=a.lat||a.lon;break;case "wkt":f=a.wkt;break;default:f=a.lat||a.lon||a.wkt}if(!f)return S3.fieldError(c+"_map_icon",i18n.map_feature_required),!1}var h=a.id;d="address L5 L4 L3 L2 L1 L0".split(" ");f=function(a){return a.hasClass("multiselect")?a.next("button.ui-multiselect").is(":visible"):a.is(":visible")};if(h){if(!e[h])return!0;var g=e[h].l;for(a=0;a<6-g;a++){h=c+
"_"+d[a];var k=b(h);if(k.length&&k.hasClass("required")&&f(k))return S3.fieldError(h,i18n.enter_value),!1}}else{if(a.lat||a.lon||a.wkt||a.address||a.postcode)return!0;for(a=0;7>a;a++)if(h=c+"_"+d[a],k=b(h),k.length&&k.hasClass("required")&&f(k))return S3.fieldError(h,i18n.enter_value),!1}return!0},_serialize:function(){var c=JSON.stringify(this.data);this.input.val(c);return c},_deserialize:function(){var c=this.input.val();return this.data=JSON.parse(c)},_storeHierarchyData:function(c,a){var b;if(a)for(b in a)e[b]=
a[b];if(c)for(b in c)f[b]=c[b]},_jsLoaded:function(){var b=new jQuery.Deferred;setTimeout(function d(){S3.gis.maps!=l?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(d,500))},1);return b.promise()},_removeErrors:function(c){c||(c="#"+this.fieldname,c=c+"_L0,"+c+"_L1,"+c+"_L2,"+c+"_L3,"+c+"_L4,"+c+"_L5,"+c+"_address,"+c+"_postcode,"+c+"_map_icon");b(c).siblings(".error").remove()},_bindEvents:function(){var c=this.fieldname,a=this.eventNamespace,d=this,
e="#"+c;b(e+"_L0").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(0)});b(e+"_L1").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(1)});b(e+"_L2").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(2)});b(e+"_L3").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(3)});b(e+"_L4").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(4)});b(e+"_L5").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(5)});b(e+"_address,"+e+"_postcode").bind("change"+
a,function(){d._removeErrors(this);d.useGeocoder?d._geocodeDecision():d._collectData()});b(e+"_lat,"+e+"_lon").bind("change"+a,function(){d._latlonInput()});b(e+"_latlon_toggle").bind("click"+a,function(){var a=b(this).data("mode")||d.options.latlonMode;if("dms"==a){a="decimal";var c=i18n.latlon_mode.dms}else a="dms",c=i18n.latlon_mode.decimal;b(e+"_lat").latloninput("option",{mode:a});b(e+"_lon").latloninput("option",{mode:a});b(this).html(c).data("mode",a)});if("sub_"==c.substring(0,4))this.input.closest(".inline-form").bind("validate"+
a+this.id,function(a){d._validate()||a.preventDefault()});else{var f=this.input.closest("form");f.bind("submit"+a+this.id,function(b){b.preventDefault();d._validate()&&f.unbind(a+d.id).submit()})}return!0},_unbindEvents:function(){var c="#"+this.fieldname,a=this.eventNamespace;b(c+"_L0,"+c+"_L1,"+c+"_L2,"+c+"_L3,"+c+"_L4,"+c+"_L5,"+c+"_address,"+c+"_postcode,"+c+"_map_icon,"+c+"_latlon_toggle").unbind(a);this.input.next(".error_wrapper").unbind(a);this.input.closest("form").unbind(a+this.id);return!0}})})(jQuery);
(function(b,l){var g=0;b.widget("s3.latloninput",{options:{type:"lat",mode:"decimal",labels:{deg:"\u00b0",min:"'",sec:'"'}},_create:function(){this.id=g;g+=1;this.eventNamespace=".latloninput"},_init:function(){b(this.element).hide();this.refresh()},_destroy:function(){b(this.element).show();b.Widget.prototype.destroy.call(this)},_setOption:function(b,f){this._super(b,f);"mode"==b&&this.refresh()},refresh:function(){this._unbindEvents();var e=b(this.element),f=this.options;this.defaultValue=e.val();
if(!this.input){var h=b("<div>").hide().insertAfter(e),c=b('<input type="text" class="dms-input" size="18">').hide();this.decimalInput=c;var a=f.labels,d=b('<input type="text" class="integer dms-input" size="5">'),g=b('<span class="dms-label">'+a.deg+"</span>"),l=b('<input type="text" class="integer dms-input" size="5">'),m=b('<span class="dms-label">'+a.min+"</span>"),k=b('<input type="text" class="double dms-input" size="8">');a=b('<span class="dms-label">'+a.sec+"</span>");this.degInput=d;this.minInput=
l;this.secInput=k;this.dmsInput=d=b("<span>").append(d).append(g).append(l).append(m).append(k).append(a).hide();this.input=h.append(c).append(d).show()}this._removeErrors();"dms"==f.mode?(e=this._getDMS(),this.degInput.val(e.d),this.minInput.val(e.m),this.secInput.val(e.s),this.decimalInput.hide(),this.dmsInput.show()):(this.decimalInput.val(e.val()),this.dmsInput.hide(),this.decimalInput.show());this._bindEvents()},_getDMS:function(){var e=b(this.element).val();if(isNaN(parseFloat(e))||!isFinite(e))return{d:"",
m:"",s:""};var f=Math.abs(e);f=60*(f-parseInt(f,10));if(1E-10>Math.abs(f-Math.round(f))){f=Math.round(f);var h=0}else h=60*(f-parseInt(f,10)),1E-10>Math.abs(h-Math.round(h))&&(h=Math.round(h));return{d:parseInt(e,10),m:parseInt(f,10),s:h}},_showError:function(b,f){"all"==b?this.input.find("input").addClass("invalidinput"):b&&b.addClass("invalidinput");f&&this.input.append('<div class="error">'+f+"</div>")},_removeErrors:function(){this.input.find("input").removeClass("invalidinput");this.input.find(".error").remove()},
_validateDMS:function(){this._removeErrors();if("lat"==this.options.type){var b=90;var f=i18n.latlon_error.lat}else b=180,f=i18n.latlon_error.lon;var h=this.degInput.val(),c=this.minInput.val(),a=this.secInput.val(),d=[];if(""===h&&""===c&&""===a)return"";h=parseInt(h,10)||0;c=parseInt(c,10)||0;a=parseFloat(a)||0;60<=Math.abs(c)&&(this._showError(this.minInput),d.push(i18n.latlon_error.min));60<=Math.abs(a)&&(this._showError(this.secInput),d.push(i18n.latlon_error.sec));c=Math.abs(h)+c/60+a/3600;
if(!d.length&&c>b||h>b)this._showError("all"),d.push(f);return d.length?(this._showError(null,d.join(", ")),null):(0>h?-1:1)*c},_validateDecimal:function(){this._removeErrors();var b=this.options.type,f=i18n.latlon_error.format;if("lat"==b){var h=90;var c=i18n.latlon_error.lat}else h=180,c=i18n.latlon_error.lon;var a=this.decimalInput.val();if(""===a)return"";a=this._parse(a,b);null===a?this._showError(this.decimalInput,f):Math.abs(a)>h&&(this._showError(this.decimalInput,c),a=null);return a},_parse:function(b,
f){var e="lat"==f?{N:1,S:-1}:{E:1,W:-1};var c=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)\s*\u00b0?\s*([NSEW])?\s*$/,a=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)?\s*([\u00b0'"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*([NSEW])?\s*$/,d=f=0,g=0;if(b.match(c))return a=b.replace(c,"$1|$2|$3").split("|"),(b=a[0]||a[2])&&(b=e[b]),f=parseFloat(a[1]),b&&Math.abs(f)!=f&&(b=null),b&&(f*=b),f;if(b.match(a)){a=b.replace(a,"$1|$2|$3|$4|$5|$6|$7|$8").split("|");(b=a[0]||a[7])&&
(b=e[b]);e=[];c=[];var l,m;for(m=1;6>m;m+=2){var k=a[m];(l=a[m+1])?(e.push(parseFloat(k)||0),c.push(l)):k&&(e.push(parseFloat(k)),c.push(null))}if(a=e.length){for(m=1;m<a;m++)e[m]=Math.abs(e[m]);k=e[0];Math.abs(k)!=k&&(b=1);if(1==a)l=c[0],'"'==l?g=e[0]:"'"==l?d=e[0]:l&&"\u00b0"!=l||(f=e[0]);else if(2==a)if(a=c[0],c=c[1],"\u00b0"==a)f=e[0],'"'==c?g=e[1]:"'"!=c&&c||(d=e[1]);else if(a){if("'"!=a||c&&'"'!=c)return null;d=e[0];g=e[1]}else'"'==c?(d=e[0],g=e[1]):"'"!=c&&c||(f=e[0],d=e[1]);else{if(c[0]&&
"\u00b0"!=c[0]||c[1]&&"'"!=c[1]||c[2]&&'"'!=c[2])return null;f=e[0];d=e[1];g=e[2]}f=f+d/60+g/3600;b&&(f*=b);return f}}return null},_bindEvents:function(){var e=this,f=this.eventNamespace;this.dmsInput.find("input").bind("change"+f,function(){var f=e._validateDMS();null!==f?b(e.element).val(f).change():b(e.element).val(e.defaultValue).change()});this.decimalInput.bind("change"+f,function(){var f=e._validateDecimal();null!==f?(b(e.element).val(f).change(),e.decimalInput.val(f)):b(e.element).val(e.defaultValue).change()});
b(this.element).bind("setvalue"+f,function(){e.refresh()});return!0},_unbindEvents:function(){var e=this.eventNamespace;this.input&&this.input.find("input").unbind(e);b(this.element).unbind(e);return!0}})})(jQuery);
