/*
 2018-2020 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires moment.js
 requires jQuery fullCalendar plugin
 requires qTip2
 requires jQuery UI datepicker
*/
(function(g,t){function r(){this.items={};this.slices=[]}var u=0;r.prototype.store=function(a,d,b){var f={};b.forEach(function(c){this.items[c.id]=f[c.id]=c},this);b=this.slices;a=[moment(a),moment(d),f];b.push(a);b.sort(function(c,e){return c[0].isBefore(e[0])?-1:e[0].isBefore(c[0])?1:c[1].isBefore(e[1])?-1:e[1].isBefore(c[1])?1:0});if(1<b.length){var h=[];a=b.reduce(function(c,e){return c[1].isBefore(e[0])||c[0].isAfter(e[1])?(h.push(c),e):[moment.min(c[0],e[0]),moment.max(c[1],e[1]),g.extend({},
c[2],e[2])]});h.push(a);this.slices=h}};r.prototype.retrieve=function(a,d){a=moment(a);d=moment(d);for(var b=this.slices,f=b.length,h,c,e=[],k=0;k<f;k++)if(h=b[k],h[0].isSameOrBefore(a)&&h[1].isSameOrAfter(d)){b=h[2];for(c in b)if(f=b[c],h=moment(f.start),!h.isAfter(d)){if(f.end){if(moment(f.end).isBefore(a))continue}else if(h.isSameOrBefore(moment(a).subtract(1,"days")))continue;e.push(f)}return e}return null};r.prototype.updateItem=function(a,d){(a=this.items[a])&&d&&g.extend(a,d)};r.prototype.deleteItem=
function(a){this.slices.forEach(function(d){delete d[2][a]});delete this.items[a]};r.prototype.clear=function(){this.slices=[];this.items={}};g.widget("s3.organizer",{options:{locale:"en",timeout:1E4,resources:null,aspectRatio:1.8,nowIndicator:!0,slotDuration:"00:30:00",snapDuration:"00:15:00",defaultTimedEventDuration:"00:30:00",businessHours:!1,timeFormat:null,labelEdit:"Edit",labelDelete:"Delete",deleteConfirmation:"Do you want to delete this entry?",firstDay:1,refreshIconClass:"fa fa-refresh",
calendarIconClass:"fa fa-calendar"},_create:function(){this.id=u;u+=1;this.eventNamespace=".organizer"},_init:function(){this.openRequest=null;this.loadCount=-1;this.refresh()},_destroy:function(){g.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options,d=a.resources,b=g(this.element),f=b.attr("id");this._unbindEvents();var h=!1,c=!1;d.forEach(function(l){l.insertable&&(h=!0);l.useTime||(c=!0)});if(a.useTime){var e="month,agendaWeek,agendaDay reload";var k="agendaWeek"}else e=
"month,basicWeek reload",k="month";var n=this,m=g("#"+f+"-date-picker");g(this.element).fullCalendar({aspectRatio:a.aspectRatio,nowIndicator:a.nowIndicator,slotDuration:a.slotDuration,snapDuration:a.snapDuration,displayEventEnd:!1,defaultTimedEventDuration:a.defaultTimedEventDuration,allDaySlot:c,firstDay:a.firstDay,timeFormat:a.timeFormat,slotLabelFormat:a.timeFormat,businessHours:a.businessHours,selectable:h,editable:!0,eventDrop:function(l,p,q){n._updateItem(l,q)},eventResize:function(l,p,q){n._updateItem(l,
q)},customButtons:{reload:{text:"Reload",click:function(){n.reload()}},calendar:{text:"Calendar",click:function(){m.datepicker("show")}}},header:{left:e,center:"title",right:"calendar today prev,next"},defaultView:k,eventRender:function(l,p){n._eventRender(l,p)},eventDestroy:function(l,p){n._eventDestroy(l,p)},select:function(l,p,q){n._selectDate(l,p,q)},unselect:function(){g(n.element).qtip("destroy",!0)},unselectCancel:".s3-organizer-create",locale:a.locale,timezone:"local"});f=g("<i>").addClass(a.refreshIconClass);
e=g("<i>").addClass(a.calendarIconClass);this.reloadButton=g(".fc-reload-button").empty().append(f);f=g(".fc-calendar-button").empty().append(e);m.datepicker("option",{showOn:"focus",showButtonPanel:!0,firstDay:a.firstDay}).insertBefore(f).on("change",function(){var l=m.datepicker("getDate");l&&b.fullCalendar("gotoDate",l)});m.datepicker("widget").hide();a=g('<div class="inline-throbber">').css({visibility:"hidden"});g(".fc-header-toolbar .fc-left",this.element).append(a);this.throbber=a;this.resources=
[];d&&d.forEach(function(l,p){this._addResource(l,p)},this);this._bindEvents()},_addResource:function(a,d){var b=g.extend({},a,{_cache:new r});this.resources.push(b);a=b.timeout;a===t&&(a=this.options.timeout);var f=this;g(this.element).fullCalendar("addEventSource",{id:""+d,allDayDefault:!b.useTime,editable:!!b.editable,startEditable:!!b.startEditable,durationEditable:!!b.end&&!!b.durationEditable,events:function(h,c,e,k){f._fetchItems(b,h,c,e,k)}})},_eventRender:function(a,d){var b=this;g(d).qtip({content:{title:function(f,
h){return b._itemTitle(a,h)},text:function(f,h){return b._itemDisplay(a,h)},button:!0},position:{at:"center right",my:"left center",effect:!1,viewport:g(window),adjust:{method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"click mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}})},_eventDestroy:function(a,d){g(d).qtip("destroy",!0)},_itemTitle:function(a){var d=[a.start.format(a.allDay&&"L"||"L LT")];a.end&&(a=moment(a.end).endOf("minute"),d.push(a.format("LT")));
return d.join(" - ")},_itemDisplay:function(a,d){var b=g('<div class="s3-organizer-popup">'),f=this.options,h=f.resources[a.source.id];g("<h6>").html(a.popupTitle).appendTo(b);var c=h.columns,e=a.description;c&&e&&c.forEach(function(q){var v=q[0];q=q[1];e[v]!==t&&(q&&g("<label>").text(q).appendTo(b),g("<p>").html(e[v]).appendTo(b))});var k=g(this.element).attr("id");c=this.eventNamespace;var n=this,m=[],l=h.baseURL;if(l){if(h.editable&&!1!==a.editable){var p=document.createElement("a");p.href=l;p.pathname+=
"/"+a.id+"/update.popup";p.search=p.search?p.search+("&refresh="+k):"?refresh="+k;k=g('<a class="action-btn s3_modal">').text(f.labelEdit).attr("href",p.href);k.on("click"+c,function(){d.hide()});m.push(k)}h.deletable&&!1!==a.deletable&&(k=g('<a class="action-btn delete-btn-ajax">').text(f.labelDelete),k.on("click"+c,function(){confirm(f.deleteConfirmation)&&(d.hide(),n._deleteItem(a,function(){d.destroy()}));return!1}),m.push(k))}m.length&&g("<div>").append(m).appendTo(b);return b},_selectDate:function(a,
d,b){var f=this;g(this.element).qtip({content:{text:function(h,c){return f._selectResource(a,d,h,c)}},position:{target:"mouse",at:"center right",my:"left center",effect:!1,viewport:g(window),adjust:{mouse:!1,method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}});g(this.element).qtip("show",b)},_selectResource:function(a,d,b,f){f.set("style.classes","s3-organizer-create");b=this.options.resources;var h=this.eventNamespace,
c=g(this.element).attr("id"),e=g("<div>");b.forEach(function(k){if(k.insertable){var n=g('<a class="action-btn s3_modal">'),m=k.labelCreate,l=k.baseURL;if(l&&m){k=n.get(0);var p=[];k.href=l;k.pathname+="/create.popup";c&&p.push("refresh="+encodeURIComponent(c));l=a.toISOString()+"--"+moment(d).subtract(1,"seconds").toISOString();p.push("organizer="+encodeURIComponent(l));k.search=k.search?k.search+("&"+p.join("&")):"?"+p.join("&");n.text(m).appendTo(e).on("click"+h,function(){f.hide()})}}});return e},
_fetchItems:function(a,d,b,f,h){if(f=a._cache.retrieve(d,b))h(f);else{f=this.options;this._showThrobber();var c;a.filterForm?c=g("#"+a.filterForm):f.filterForm&&(c=g("#"+f.filterForm));var e=S3.search.getCurrentFilters(c).filter(function(m){m=m[0].split("__")[0];return m!==a.start&&m!==a.end});if(c=a.ajaxURL){c=S3.search.filterURL(c,e);e=encodeURIComponent(d.toISOString()+"--"+b.toISOString());c=-1!=c.indexOf("?")?c+("&$interval="+e):c+("?$interval="+e);e=a.timeout;var k=g.ajaxS3;e===t&&(e=f.timeout);
g.searchS3!==t&&(k=g.searchS3);if(f=a.openRequest)f.onreadystatechange=null,f.abort();var n=this;a.openRequest=k({timeout:e,url:c,dataType:"json",type:"GET",success:function(m){m=n._decodeServerData(a,m);n._hideThrobber();a._cache.store(d,b,m);h(m)},error:function(m,l,p){n._hideThrobber();console.log("UNAUTHORIZED"==p?i18n.gis_requires_login:m.responseText)}})}}},_decodeServerData:function(a,d){var b=d.c;d=d.r;var f=[],h=0,c=a.colors;b&&b.constructor===Array&&(h=b.length);d.forEach(function(e){var k=
{},n=e.d;if(h&&n&&n.constructor===Array){var m=n.length;if(m<=h)for(var l=0;l<m;l++)k[b[l]]=n[l]}(n=e.e)&&(n=a.useTime?moment(n).add(1,"seconds").toISOString():moment(n).add(1,"days").startOf("day").toISOString());m=e.t;k={id:e.id,title:g("<div>").html(m).text(),popupTitle:m,start:e.s,end:n,description:k};e.pe||(k.editable=!1);e.pd||(k.deletable=!1);c&&e.c&&(e=c[e.c],e!==t&&(k.color=e));f.push(k)});return f},_updateItem:function(a,d){var b=this.resources[a.source.id],f=this,h={id:a.id,s:a.start.toISOString()};
b.end&&(h.e=b.useTime?moment(a.end).subtract(1,"seconds").toISOString():moment(a.end).subtract(1,"days").endOf("day").toISOString());this._sendItems(b,{u:[h]},function(){b.reloadOnUpdate?f.reload():b._cache.updateItem(a.id,{start:a.start,end:a.end})},d)},_deleteItem:function(a,d){var b=this.resources[a.source.id],f={id:a.id},h=g(this.element);this._sendItems(b,{d:[f]},function(){h.fullCalendar("removeEvents",function(c){return c.source.id==a.source.id&&c.id==a.id});b._cache.deleteItem(a.id);"function"===
typeof d&&d()})},_sendItems:function(a,d,b,f){var h=g('input[name="_formkey"]',this.element).val();d=JSON.stringify(g.extend({k:h},d));this._showThrobber();var c=this;g.ajaxS3({type:"POST",url:a.ajaxURL,data:d,dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",success:function(){"function"===typeof b&&b();c._hideThrobber()},error:function(){"function"===typeof f&&f();c._hideThrobber()}})},reload:function(){this.resources.forEach(function(a){a._cache.clear()});g(this.element).fullCalendar("refetchEvents")},
_showThrobber:function(){this.reloadButton.prop("disabled",!0);this.throbber.css({visibility:"visible"})},_hideThrobber:function(){this.throbber.css({visibility:"hidden"});this.reloadButton.prop("disabled",!1)},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
