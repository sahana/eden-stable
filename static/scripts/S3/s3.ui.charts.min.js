/*
 2018-2020 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(m,v){var t=0;m.widget("s3.uiChart",{options:{height:"280px",colors:null,transition:50,staggerLabels:!0,valueFormat:",.0f"},_create:function(){this.id=t;t+=1;this.eventNamespace=".uiChart"},_init:function(){this.refresh()},_destroy:function(){m.Widget.prototype.destroy.call(this)},refresh:function(){var d=m(this.element),b=this.options;this._unbindEvents();d.empty().css({height:b.height});b=d3.select(d.get(0)).append("svg").attr("class","nv");switch(d.data("type")){case "piechart":this._pieChart(b);
break;case "barchart":this._barChart(b);break;case "multibarchart":this._multiBarChart(b)}this._bindEvents()},_getData:function(d){var b=m(this.element).data("source");b&&m.ajaxS3({url:b,dataType:"json",type:"GET",ignoreStatus:[404],success:function(c){d(c)},error:function(c,a,g){d([]);console.log("UNAUTHORIZED"==g?i18n.gis_requires_login:c.responseText)}})},_barChart:function(d){var b=m(this.element),c=this.options,a=nv.models.discreteBarChart().duration(c.transition).x(function(e){return e.label}).y(function(e){return e.value}).staggerLabels(c.staggerLabels).showValues(!0),
g=d3.format(c.valueFormat);a.yAxis.tickFormat(g);a.valueFormat(g);c.colors&&a.color(c.colors);var f=b.data("url"),h=b.data("items"),n=this;nv.addGraph(function(){n._getData(function(e){d.datum(e).call(a);a.update();nv.utils.windowResize(a.update);if(f&&h)a.discretebar.dispatch.on("elementClick",function(l){var k={};k[h]=l.data.filterKey;l=n._updateURL(f,k);window.open(l,"_blank")})})});return a},_multiBarChart:function(d){var b=m(this.element),c=this.options,a=nv.models.multiBarChart().duration(c.transition).x(function(e){return e.label}).y(function(e){return e.value}).reduceXTicks(!1).staggerLabels(c.staggerLabels).stacked(!0).groupSpacing(.1),
g=d3.format(c.valueFormat);a.yAxis.tickFormat(g);"off"==b.data("controls")&&a.showControls(!1);"off"==b.data("legend")&&a.showLegend(!1);c.colors&&a.color(c.colors);var f=b.data("url"),h=b.data("items"),n=this;nv.addGraph(function(){n._getData(function(e){d.datum(e).call(a);a.update();nv.utils.windowResize(a.update);if(f&&h){var l=b.data("series");a.multibar.dispatch.on("elementClick",function(k){var p={};p[h]=k.data.filterKey;l&&(p[l]=k.element.parentElement.__data__.filterKey);k=n._updateURL(f,
p);window.open(k,"_blank")})}})});return a},_updateURL:function(d,b){var c=document.createElement("a");c.href=d;d=[];for(var a in b)d.push(encodeURIComponent(a)+"="+encodeURIComponent(b[a]));d.length&&(c.search=c.search?c.search+d.join("&"):"?"+d.join("&"));return c.href},_pieChart:function(d){var b=m(this.element),c=this.options,a="off"!=b.data("legend"),g=b.data("labels"),f=b.data("labeltype"),h=.05,n=!0;f||(f=a?"percent":"key");switch(g){case "off":g=!1;break;case "outside":g=!0;a&&(h="percent"==
f||"value"==f?.03:.2);break;default:g=!0,n=!1,a?"percent"!=f&&"value"!=f&&(h=.25):h=.1}var e=nv.models.pieChart().duration(c.transition).x(function(q){return q.label}).y(function(q){return q.value}).showLabels(g).labelType(f).showLegend(a).labelsOutside(n).labelThreshold(h).showTooltipPercent(!0);a=d3.format(c.valueFormat);e.valueFormat(a);c.colors&&e.color(c.colors);var l=b.data("url"),k=b.data("items"),p=this;nv.addGraph(function(){p._getData(function(q){d.datum(q).call(e);e.update();nv.utils.windowResize(e.update);
if(l&&k)e.pie.dispatch.on("elementClick",function(r){var u={};u[k]=r.data.filterKey;r=p._updateURL(l,u);window.open(r,"_blank")})})});return e},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
