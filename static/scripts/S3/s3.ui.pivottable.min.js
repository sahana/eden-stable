/*
 2013-2020 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js 1.8.5 (patched)

*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,n,k){b instanceof String&&(b=String(b));for(var a=b.length,c=0;c<a;c++){var d=b[c];if(n.call(k,d,c,b))return{i:c,v:d}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,n,k){if(b==Array.prototype||b==Object.prototype)return b;b[n]=k.value;return b};$jscomp.getGlobal=function(b){b=["object"==typeof globalThis&&globalThis,b,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var n=0;n<b.length;++n){var k=b[n];if(k&&k.Math==Math)return k}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(b,n){var k=$jscomp.propertyToPolyfillSymbol[n];if(null==k)return b[n];k=b[k];return void 0!==k?k:b[n]};
$jscomp.polyfill=function(b,n,k,a){n&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(b,n,k,a):$jscomp.polyfillUnisolated(b,n,k,a))};$jscomp.polyfillUnisolated=function(b,n,k,a){k=$jscomp.global;b=b.split(".");for(a=0;a<b.length-1;a++){var c=b[a];c in k||(k[c]={});k=k[c]}b=b[b.length-1];a=k[b];n=n(a);n!=a&&null!=n&&$jscomp.defineProperty(k,b,{configurable:!0,writable:!0,value:n})};
$jscomp.polyfillIsolated=function(b,n,k,a){var c=b.split(".");b=1===c.length;a=c[0];a=!b&&a in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var d=0;d<c.length-1;d++){var e=c[d];e in a||(a[e]={});a=a[e]}c=c[c.length-1];k=$jscomp.IS_SYMBOL_NATIVE&&"es6"===k?a[c]:null;n=n(k);null!=n&&(b?$jscomp.defineProperty($jscomp.polyfills,c,{configurable:!0,writable:!0,value:n}):n!==k&&($jscomp.propertyToPolyfillSymbol[c]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(c):$jscomp.POLYFILL_PREFIX+c,c=$jscomp.propertyToPolyfillSymbol[c],
$jscomp.defineProperty(a,c,{configurable:!0,writable:!0,value:n})))};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,k){return $jscomp.findInternal(this,b,k).v}},"es6","es3");
(function(b,n){var k=0;b.widget("s3.pivottable",{options:{showTotals:!0,ajaxURL:null,defaultChart:{type:"breakdown",axis:"rows"},renderFilter:!0,renderOptions:!0,renderChart:!0,renderTable:!0,collapseFilter:!1,collapseOptions:!0,collapseChart:!0,collapseTable:!1,exploreChart:!1,filterURL:null,filterForm:null,filterTab:null,autoSubmit:1E3,timeout:1E4,thousandSeparator:" ",thousandGrouping:"3",minTickSize:null,precision:null,textAll:"All",labelRecords:"Records"},_create:function(){this.id=k;k+=1;this.openRequest=
this.chart=this.table=null;this.eventNamespace=".pt"},_init:function(){var a=b(this.element),c=this.options;this.table=this.data=null;this.chartOptions={currentChart:null,currentDataIndex:null,currentSeriesIndex:null,currentSpectrumIndex:null};this.table_options={hidden:!1};var d=a.find(".pt-chart");this.chart=d.length?d.first():null;c.renderFilter||c.renderOptions?(d="#"+a.attr("id"),c.renderOptions?(b(d+"-options").show(),c.collapseOptions&&(b(d+"-options legend").siblings().toggle(),b(d+"-options legend").children().toggle())):
b(d+"-options").hide(),c.renderFilter?(b(d+"-filters").show(),c.collapseFilter&&(b(d+"-filters legend").siblings().toggle(),b(d+"-filters legend").children().toggle())):b(d+"-options").hide()):a.find(".pt-form-container").hide();c.collapseTable&&(this.table_options.hidden=!0,a.find(".pt-table").hide(),a.find(".pt-show-table").show(),a.find(".pt-hide-table").hide());c.numberFormatter=function(a){var b=c.precision;if(null===a||"undefined"==typeof a)return"-";b=b||0==b?a.toFixed(b):a.toString();b=b.split(".");
a=b[0];b=1<b.length?"."+b[1]:"";a=a.replace(new RegExp("\\B(?=(\\d{"+c.thousandGrouping+"})+(?!\\d))","g"),c.thousandSeparator);return a+b};this.refresh()},_destroy:function(){this.table&&this.table.remove();this.chart&&this.chart.empty()},refresh:function(){var a=b(this.element),c=null;this._unbindEvents();var d=a.find('input[type="hidden"][name="pivotdata"]');d.length&&(c=JSON.parse(b(d).first().val()));c?"count"==c.method&&(this.options.precision=0,this.options.minTickSize=1):(c={empty:!0},a.find(".pt-hide-table").hide(),
a.find(".pt-show-table").hide(),a.find(".pt-export-opt").hide());this.data=c;this.lookups={};c.nodata?(a.find(".pt-table").first().empty().append(b('<div class="pt-no-data">'+c.nodata+"</div>")),a.find(".pt-hide-table").hide(),a.find(".pt-show-table").hide(),a.find(".pt-export-opt").hide()):(this._renderTable(),this._renderChartOptions());this._renderChart();c.empty?a.find(".pt-empty").show():a.find(".pt-empty").hide();this.options.autoSubmit?a.find(".pt-submit").hide():a.find(".pt-submit").show();
this._bindEvents();a.find(".pt-throbber").hide()},_renderTable:function(){var a=b(this.element),c=a.find(".pt-table").first().empty();this.table=null;var d=this.data;if(!d.empty)if(this.options.renderTable){var e=d.cells.slice(0),f=d.cols,h=d.rows,l=d.total,g=d.labels,m=!1,t=!1;d=d.facts;1==d.length&&"list"!=d[0][1]&&(1==h.length&&null===h[0][4]&&(m=!0),1==f.length&&null===f[0][4]&&(t=!0));d=this.options;var u=d.showTotals,q;if(t&&u)for(f=[],q=0;q<h.length;q++)e[q]=[];else{var k=function(a,b){return"__other__"!=
f[b][0]};for(q=0;q<h.length;q++)e[q]=e[q].filter(k);f=f.filter(function(a){return"__other__"!=a[0]})}m&&u?(h=[],e=[]):(e=e.filter(function(a,b){return"__other__"!=h[b][0]}),h=h.filter(function(a){return"__other__"!=a[0]}));c=d3.select(c.get(0)).append("table").attr("class","dataTable display report");c.append("thead").call(this._renderHeader,f,g,d).call(this._renderColumns,f,g,t);m&&u||c.append("tbody").call(this._renderRows,this,h,f,g,e,d);u&&c.append("tfoot").call(this._renderFooter,h,f,g,l);this.table=
b(c.node());this.table_options.hidden?(a.find(".pt-show-table").show(),a.find(".pt-hide-table").hide(),a.find(".pt-export-opt").hide()):(a.find(".pt-show-table").hide(),a.find(".pt-hide-table").show(),a.find(".pt-export-opt").show())}else a.find(".pt-show-table").hide(),a.find(".pt-hide-table").hide(),a.find(".pt-export-opt").hide()},_renderHeader:function(a,b,d,e){a=a.append("tr");a.append("th").attr("scope","col").text(d.layer);b.length&&a.append("th").attr({scope:"col",colspan:b.length}).text(d.cols);
e.showTotals&&a.append("th").attr({scope:"col","class":"pt-totals-header pt-row-total",rowspan:2}).text(d.total);return a},_renderColumns:function(a,b,d,e){a=a.append("tr");a.append("th").attr({scope:"col","class":"pt-rows-header"}).text(d.rows);a.selectAll("th.pt-data").data(b).enter().append("th").attr({scope:"col","class":"pt-col-label"}).text(function(a){return e?"":a[4]});return a},_renderRows:function(a,b,d,e,f,h,l){d=a.selectAll("tr.pt-row").data(d).enter().append("tr").attr("class",function(a,
b){return b%2?"odd":"even"});d.append("td").text(function(a){return a[4]});d.selectAll("td.pt-cell").data(function(a,b){return h[b]}).enter().append("td").attr("class","pt-cell").each(b._renderCell,f);l.showTotals&&d.append("td").attr("class","pt-row-total").text(function(a){return a[2][0]});return d},_renderCell:function(a,c,d){c=d3.select(this);for(var e=a.i,f,h=0,l=e.length;h<l;h++){f=e[h];var g=c.append("div").attr("class","pt-cell-value");null===f?g.text(d.none):b.isArray(f)?g.append("ul").selectAll("li").data(f).enter().append("li").html(function(a){return a}):
g.text(f);1<l-h&&g.append("span").text(" / ")}(a=a.k)&&a.length&&(b(c.node()).data("recordIDs",a),c.append("div").attr("class","pt-cell-zoom"))},_renderCellRecords:function(a,c){var d=b(".pt-cell-zoom",a).removeClass("opened");a=b(".pt-cell-records",a).remove();if(c){var e=this.lookups,f=[],h,l=[];c.forEach(function(a){if(h=e[a]){if(h.constructor===Array){a=h[1];if(-1!=l.indexOf(a))return;l.push(a);h=h[0]}h&&f.push(h)}});a=b('<div class="pt-cell-records">');var g=b("<ul>").appendTo(a);f.length?(f.sort(function(a,
b){return a.localeCompare(b)}),f.forEach(function(a){b("<li>").html(a).appendTo(g)})):b("<li>").text(c.length+" "+this.options.textRecords).appendTo(g);d.addClass("opened").after(a)}},_renderFooter:function(a,b,d,e,f){b=b.length%2?"odd":"even";a=a.append("tr").attr("class",b+" pt-totals-row");a.append("th").attr({"class":"pt-totals-header",scope:"row"}).text(e.total);a.selectAll("td.pt-col-total").data(d).enter().append("td").attr("class","pt-col-total").text(function(a){return a[2][0]});a.append("td").attr("class",
"pt-total").text(f);return a},_renderChartOptions:function(){var a=b(this.element),c=a.find(".pt-chart-controls").first().empty(),d=this.data;if(!d.empty&&this.options.renderChart){d=d.labels;var e=a.attr("id");a=d.layer;var f=d.rows,h=d.cols,l=d.per,g=b('<div class="pt-chart-opts">'),m=e+"-pchart-rows",t=e+"-vchart-rows",u=e+"-hchart-rows",k=e+"-schart-rows",n=e+"-pchart-cols",p=e+"-vchart-cols",v=e+"-hchart-cols";e+="-schart-cols";a&&b(g).append(b('<span class="pt-chart-label">'+a+": </span>"));
f&&b(g).append(b('<div id="'+m+'" class="pt-chart-icon pt-pchart"/><div id="'+t+'" class="pt-chart-icon pt-vchart"/><span class="pt-chart-label">'+l+" "+f+"</span>"));h&&b(g).append(b('<div id="'+n+'" class="pt-chart-icon pt-pchart"/><div id="'+p+'" class="pt-chart-icon pt-vchart"/><span class="pt-chart-label">'+l+" "+h+"</span>"));f&&h&&b(g).append(b('<span class="pt-chart-label">| '+d.breakdown+': </span><div id="'+k+'" class="pt-chart-icon pt-schart"/><div id="'+u+'" class="pt-chart-icon pt-hchart"/><span class="pt-chart-label">'+
l+" "+f+'</span><div id="'+e+'"  class="pt-chart-icon pt-schart"/><div id="'+v+'"  class="pt-chart-icon pt-hchart"/><span class="pt-chart-label">'+l+" "+h+"</span>"));b(c).append(g)}},_truncateLabel:function(a,b){return a&&a.length>b?a.substring(0,b-3).replace(/\s+$/g,"")+"...":a},_renderChart:function(a){var c=b(this.element),d=this.data;b(".pt-chart-contents",c).hide();if(c=this.chart)if(b(c).off("plothover").off("plotclick").empty(),!d.empty&&this.options.renderChart)if(!1===a)this.options.collapseChart=
!0;else{c=this.options.collapseChart;if("undefined"==typeof a||!a){if(c)return;a=this.chartOptions.currentChart}if("undefined"==typeof a||!a){if(c)return;a=this.options.defaultChart}if("undefined"!=typeof a&&a){this.options.collapseChart=!1;this.chartOptions.currentChart=a;c=a.type;a=a.axis;var e=d.labels,f=e.per,h=e.layer+" "+f+" "+e.rows;e=e.layer+" "+f+" "+e.cols;f=d.filter;var l=f[0],g=f[1];"piechart"==c?"rows"==a?this._renderPieChart(d.rows,h,l):this._renderPieChart(d.cols,e,g):"barchart"==c?
"rows"==a?this._renderBarChart(d.rows,d.facts,h,l):this._renderBarChart(d.cols,d.facts,e,g):"breakdown"==c?"rows"==a?this._renderBreakDown(d,0,h,f):this._renderBreakDown(d,1,e,f):"spectrum"==c&&this._renderSpectrum(d,a,f)}}},_renderPieChart:function(a,c,d){var e=this.chart;if(e){b(e).css({height:"360px"}).closest(".pt-chart-contents").show().css({width:"98%"});c?b(e).siblings(".pt-chart-title").html("<h4>"+c+"</h4>"):b(e).siblings(".pt-chart-title").empty();var f=[],h=0;for(c=0;c<a.length;c++){var l=
a[c];!l[1]&&0<=l[2][0]&&(f.push({index:l[0],label:l[4],value:l[2][0],key:l[3]}),h+=l[2][0])}var g=this;g.chartOptions.currentDataIndex=null;var m=function(a){var c=a.index;if(g.chartOptions.currentDataIndex!=c){g._removeChartTooltip();g.chartOptions.currentDataIndex=c;a=a.data;var d=a.value,e=d3.event;g._renderChartTooltip(e.pageX,e.pageY,'<div class="pt-tooltip-label">'+a.label+'</div><div class="pt-tooltip-text">'+(d+" ("+Math.round(d/h*100)+"%)</div>"));b(".pt-tooltip-label").css({color:nv.utils.defaultColor()({},
c)})}};nv.addGraph(function(){var a=nv.models.pieChart().x(function(a){return a.label}).y(function(a){return a.value}).labelsOutside(!1).labelType("percent").labelThreshold(.03).showLegend(!0);a.tooltip.enabled(!1);a.legend.align(!0).rightAlign(!1);a.pie.dispatch.on("elementMouseover",m).on("elementMouseout",function(){b(".pt-tooltip").remove();g.chartOptions.currentDataIndex=null;g.chartOptions.currentSeriesIndex=null});if(g.options.exploreChart&&d)a.pie.dispatch.on("elementClick",function(a){a=
a.data;g._chartExplore([["__other__"==a.index?d+"__belongs":d,a.key]])});d3.select(b(e).get(0)).append("svg").attr("class","nv").datum(f).transition().duration(1200).call(a);nv.utils.windowResize(a.update);return a})}},_renderBarChart:function(a,c,d,e){var f=this.chart;if(f){b(f).closest(".pt-chart-contents").show().css({width:"96%"});for(var h=[],l=this._truncateLabel,g,m,t,k=0;k<c.length;k++){g={key:c[k][2]};m=[];for(var n=0;n<a.length;n++)t=a[n],m.push({label:t[4],value:t[2][k],filterIndex:t[0],
filterKey:t[3]});g.values=m;h.push(g)}b(f).css({height:"360px"});d?b(f).siblings(".pt-chart-title").html("<h4>"+d+"</h4>"):b(f).siblings(".pt-chart-title").empty();var r=function(a){a=a.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+nv.utils.defaultColor()({},a.index)+'">'+a.label+'</div><div class="pt-tooltip-text">'+a.value+"</div></div>"},p=this,v=this.options.numberFormatter;nv.addGraph(function(){if(1<h.length){var a=nv.models.multiBarChart().x(function(a){return a.label}).y(function(a){return a.value}).staggerLabels(!0).showControls(!1);
var c=a.multibar}else a=nv.models.discreteBarChart().x(function(a){return a.label}).y(function(a){return a.value}).staggerLabels(!0).showValues(!0),a.valueFormat(v),c=a.discretebar;a.tooltip.contentGenerator(r);a.yAxis.tickFormat(v);a.xAxis.tickFormat(function(a){return l(a,18)});d3.select(b(f).get(0)).append("svg").attr("class","nv").datum(h).transition().duration(500).call(a);if(p.options.exploreChart&&e)c.dispatch.on("elementClick",function(a){var b=a.data.filterKey;null===b&&(b="None");var c=
e;"__other__"==a.data.filterIndex&&(c+="__belongs");p._chartExplore([[c,b]])});nv.utils.windowResize(a.update);return a})}},_renderBreakDown:function(a,c,d,e){var f=this.chart;if(f){b(f).closest(".pt-chart-contents").show().css({width:"96%"});var h=a.cells,l=[],g=[];if(0===c){var m=a.rows;var k=a.cols;a=function(a,b){return h[l[a]][g[b]].v[0]};var n=e[0];var q=e[1]}else m=a.cols,k=a.rows,a=function(a,b){return h[g[b]][l[a]].v[0]},n=e[1],q=e[0];var r;e=[];c=[];var p=0;for(r=m.length;p<r;p++)m[p][1]||
(e.push(m[p]),l.push(p));p=0;for(r=k.length;p<r;p++)k[p][1]||(c.push(k[p]),g.push(p));var v=[];for(m=0;m<c.length;m++){k={key:c[m][4],filterIndex:c[m][0],filterKey:c[m][3]};p=[];for(r=0;r<e.length;r++)p.push({label:e[r][4],filterIndex:e[r][0],filterKey:e[r][3],value:a(r,m)});k.values=p;v.push(k)}a=Math.max(e.length*Math.max(16*(c.length+1),50)+70,360);b(f).css({height:a+"px"});d?b(f).siblings(".pt-chart-title").html("<h4>"+d+"</h4>"):b(f).siblings(".pt-chart-title").empty();var z=function(a){var b=
a.series[0];a=a.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+nv.utils.defaultColor()({},a.index)+'">'+b.key+'</div><div class="pt-tooltip-text">'+a.label+': <span class="pt-tooltip-value">'+a.value+"</span></div></div>"},A=this,w=this.options.numberFormatter,B=this._truncateLabel;nv.addGraph(function(){var a=nv.models.multiBarHorizontalChart().x(function(a){return a.label}).y(function(a){return a.value}).margin({top:20,right:20,bottom:20,left:175}).showValues(!0).duration(350).showControls(!0);
a.tooltip.contentGenerator(z);a.valueFormat(w);a.yAxis.tickFormat(w);a.xAxis.tickFormat(function(a){return B(a,24)});d3.select(b(f).get(0)).append("svg").attr("class","nv").datum(v).call(a);if(A.options.exploreChart&&n&&q)a.multibar.dispatch.on("elementClick",function(a){a=a.data;var b=d3.event.currentTarget.parentElement.__data__,c=b.filterKey;null===c&&(c="None");b="__other__"==b.filterIndex?q+"__belongs":q;var d=a.filterKey;null===d&&(d="None");A._chartExplore([["__other__"==a.filterIndex?n+"__belongs":
n,d],[b,c]])});nv.utils.windowResize(a.update);return a})}},_renderSpectrum:function(a,c,d){var e=this.chart;if(e){var f=this,h=a.cells,l=a.labels;if("rows"==c){var g=a.rows;var m=a.cols;c=l.rows;var k=l.cols;var u=d[0];var q=d[1];var r=function(a,b){return h[a][b]}}else g=a.cols,m=a.rows,c=l.cols,k=l.rows,u=d[1],q=d[0],r=function(a,b){return h[b][a]};var p=function(a,b){return null===a?m[b]:null===b?g[a]:r(a,b)},v=function(a,b){b===n&&(b="silver");for(var c=[],d,e,f=0;f<m.length;f++)d=p(null,f),
e=null===a?d[2][0]:p(a,f).v[0],!d[1]&&0<=d[2][0]&&c.push({filterIndex:d[0],filterKey:d[3],label:d[4],value:e,color:b});return c},z=[],A=0;for(d=0;d<g.length;d++){var w=p(d,null);!w[1]&&0<=w[2][0]&&(z.push({position:d,filterIndex:w[0],filterKey:w[3],label:w[4],value:w[2][0]}),A+=w[2][0])}f.chartOptions.currentDataIndex=null;b(e).removeAttr("style").closest(".pt-chart-contents").css({width:"98%",height:"auto"}).show();b(e).siblings(".pt-chart-title").empty();d=b('<div class="pt-spectrum-pie">').appendTo(e);
e=b('<div class="pt-spectrum-bar">').appendTo(e);var B=this.options.numberFormatter,H=this._truncateLabel,x=nv.models.discreteBarChart().x(function(a){return a.label}).y(function(a){return a.value}).color(["silver"]).staggerLabels(!0).showValues(!0);x.tooltip.contentGenerator(function(a){a=a.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+(a.color||["silver"])+'">'+a.label+'</div><div class="pt-tooltip-text">'+B(a.value)+"</div></div>"});x.valueFormat(B);x.yAxis.tickFormat(B);
x.xAxis.tickFormat(function(a){return H(a,18)});var D=d3.select(b(e).get(0)).append("svg").attr("class","nv");e=Math.floor(d.width()/2)-30;var y=nv.models.pieChart().x(function(a){return a.label}).y(function(a){return a.value}).height(280).width(e).margin({top:-20,left:20}).labelType("percent").labelThreshold(.1).showLegend(!1).donut(!0).donutRatio(.35);y.tooltip.enabled(!1);y.legend.align(!0).rightAlign(!1);y.pie.startAngle(function(a){return a.startAngle/2-Math.PI/2}).endAngle(function(a){return a.endAngle/
2-Math.PI/2});y.pie.dispatch.on("elementMouseover",function(a){var c=a.index;if(f.chartOptions.currentDataIndex!=c){f._removeChartTooltip();f.chartOptions.currentDataIndex=c;a=a.data;var d=a.value,e=d3.event;f._renderChartTooltip(e.pageX,e.pageY,'<div class="pt-tooltip-label">'+a.label+'</div><div class="pt-tooltip-text">'+(d+" ("+Math.round(d/A*100)+"%)</div>"));b(".pt-tooltip-label").css({color:nv.utils.defaultColor()({},c)})}}).on("elementMouseout",function(){b(".pt-tooltip").remove();f.chartOptions.currentDataIndex=
null;f.chartOptions.currentSeriesIndex=null});var E=d3.select(b(d).get(0)).append("svg").attr("class","nv").style({"min-width":e-30+"px"});e=d3.select(b(d).get(0)).append("div").attr("class","pt-spectrum-form");e.append("h4").html(l.layer+" "+l.per+" "+k);e.append("label").html(c+":");var C=e.append("select");C.append("option").attr("value","null").style("font-weight","bold").html(f.options.textAll);C.selectAll(".pt-series-item").data(z).enter().append("option").attr("class","pt-series-item").attr("value",
function(a,b){return b}).html(function(a){return a.label});e.append("label").html(l.total+":");var G=e.append("span").text(a.total),F=function(b){if(null===b||f.chartOptions.currentSpectrumIndex==b){var c=function(a,b){return nv.utils.defaultColor()({},b)};E.selectAll(".nv-slice").style("fill",c).style("stroke",c);c=v(null);D.datum([{key:null,filterIndex:null,filterKey:null,values:c}]);x.update();f.chartOptions.currentSpectrumIndex=null;C.property("value","null");G.text(a.total)}else{var d=z[b],e=
nv.utils.defaultColor()({},b);c=function(a,c){return c==b?e:"silver"};E.selectAll(".nv-slice").style("fill",c).style("stroke",c);c=v(d.position,e);D.datum([{key:d.position,filterIndex:d.filterIndex,filterKey:d.filterKey,values:c}]);x.update();f.chartOptions.currentSpectrumIndex=b;C.property("value",b);G.text(z[b].value)}};y.pie.dispatch.on("elementClick",function(a){F(a.index)});C.on("change.pt",function(){var a=d3.select(this).property("value");"null"==a?F(null):F(a)});nv.addGraph(function(){E.datum(z).transition().duration(1200).call(y);
nv.utils.windowResize(y.update);return y});nv.addGraph(function(){D.datum([{key:null,filterIndex:null,filterKey:null,values:v(null)}]).transition().duration(500).call(x);if(f.options.exploreChart&&u&&q)x.discretebar.dispatch.on("elementClick",function(a){var b=a.data,c=d3.event.currentTarget.parentElement.__data__;a=c.filterIndex;c=c.filterKey;var d=b.filterIndex;b=b.filterKey;var e=[];null!==a&&e.push(["__other__"==a?u+"__belongs":u,c||"None"]);null!==d&&e.push(["__other__"==d?q+"__belongs":q,b||
"None"]);f._chartExplore(e)});nv.utils.windowResize(x.update);return x})}},_chartExplore:function(a){var c=this.options,d=b(this.element).closest(".ui-tabs"),e=c.filterTab;if(d.length&&!1!==e)c=(c=c.filterForm)?b("#"+c):n,S3.search.setCurrentFilters(c,a),a=e?b("#"+e).index():0,d.tabs("option","active",a);else if(d=c.filterURL)a=this._updateURL(d,a),window.open(a,"_blank")},_cellExplore:function(a){if(b(".pt-cell-records",a).length)this._renderCellRecords(a,!1);else{var c=a.data("recordIDs");if(c.length){var d=
b.Deferred(),e=this;d.promise().then(function(){e._renderCellRecords(a,c)});var f=this._updateAjaxURL({explore:"1"},null,!0),h=this.lookups,l=c.filter(function(a){return!h.hasOwnProperty(a)});if(l.length){var g=b(".pt-cell-zoom",a).hide(),m=b('<div class="inline-throbber">');m.css({display:"inline-block"}).insertAfter(g);b.ajaxS3({type:"POST",url:f,data:JSON.stringify(l),dataType:"json",contentType:"application/json; charset=utf-8",success:function(a){b.extend(e.lookups,a);d.resolve();m.remove();
g.show()},error:function(){d.reject();m.remove();g.show()}})}else d.resolve()}}},_renderChartTooltip:function(a,c,d){b('<div class="pt-tooltip">'+d+"</div>").css({position:"absolute",display:"none",top:c-50,left:a+10,border:"1px solid #999",padding:"10px","min-height":"50px","max-width":"240px","z-index":"501","background-color":"white",color:"#000",opacity:.95}).appendTo("body").fadeIn(200)},_removeChartTooltip:function(){b(".pt-tooltip").remove();this.chartOptions.currentDataIndex=null;this.chartOptions.currentSeriesIndex=
null},_getOptions:function(){var a="#"+b(this.element).attr("id");return{rows:b(a+"-rows").val(),cols:b(a+"-cols").val(),fact:b(a+"-fact").val(),totals:b(a+"-totals").is(":checked")?1:0}},_getFilters:function(){var a="#"+b(this.element).attr("id"),c=null;a=b(a+"-filters");if(a.length)try{c=S3.search.getCurrentFilters(a.first())}catch(d){}return c},_updateURL:function(a,b){var c=[],e={},f;if(b){var h=0;for(f=b.length;h<f;h++){var l=b[h];var g=l[0];e[g]=!0;c.push(g+"="+l[1])}}b=this.options.ajaxURL.split("?");
if(1<b.length){l=b[1].split("&");b={};h=0;for(f=l.length;h<f;h++){var m=l[h].split("=");1<m.length&&(g=decodeURIComponent(m[0]),e[g]||(c.push(g+"="+decodeURIComponent(m[1])),b[g]=!0))}for(g in b)e[g]=!0}b=a.split("?");if(1<b.length)for(l=b[1].split("&"),h=0,f=l.length;h<f;h++)m=l[h].split("="),1<m.length&&(g=decodeURIComponent(m[0]),e[g]||c.push(g+"="+decodeURIComponent(m[1])));a=c.join("&");c=b[0];a&&(c=c+"?"+a);return c},_updateAjaxURL:function(a,c,d){var e=this.options.ajaxURL.split("?"),f=[],
h=!1;if(1<e.length){var l=e[1];l=l.split("&")}else l="",l=[];if(a)for(k in a){var g=a[k];var m=k+"="+g;"totals"==k?this.options.showTotals=g?!0:!1:h||-1!=b.inArray(m,l)||(h=!0);f.push(m)}var k={};var n={},q;if(c){var r=function(a){var b,c,d=[];["contains","anyof","belongs","eq"].forEach(function(e){b=new RegExp("__"+e+"$","g");a.match(b)?c=b:d.push(e)});c&&d.forEach(function(b){n[a.replace(c,"__"+b)]=!0})};g=0;for(q=c.length;g<q;g++){m=c[g];var p=m[0];m=m[1];r(p);null===m?k[p]||(n[p]=!0):(n[p]&&(n[p]=
!1),m=p+"="+encodeURIComponent(m),k[p]?k[p].push(m):k[p]=[m])}}g=0;for(q=l.length;g<q;g++)m=l[g].split("="),1<m.length&&(p=decodeURIComponent(m[0]),m=decodeURIComponent(m[1]),n[p]?h=!0:k[p]?h||-1!=b.inArray(p+"="+m,k[p])||(h=!0):"aggregate"!=p&&(a&&a.hasOwnProperty(p)||f.push(l[g])));for(p in k)for(g=0,q=k[p].length;g<q;g++)h||-1!=b.inArray(k[p][g],l)||(h=!0),f.push(k[p][g]);a=f.join("&");e=e[0];a&&(e=e+"?"+a);if(d)return e;this.options.ajaxURL=e;return h},_setExtension:function(a,b){var c=document.createElement("a");
c.href=a;a=c.pathname.split("/");var e=[];a.length&&(a.forEach(function(a){var b=a.lastIndexOf(".");-1!=b?e.push(a.slice(0,b)):e.push(a)}),e[e.length-1]+="."+b,c.pathname=e.join("/"));var f=c.search;f&&(e=f.slice(1).split().filter(function(a){return"format"!=a.split("=")[0]}),a.length||e.push("format="+b),c.search="?"+e.join("&"));return c.href},reload:function(a,c,d){d="undefined"!=typeof d?d:!0;"undefined"==typeof c&&(c=this._getFilters());var e=this,f=this.element,h=f.find('input[type="hidden"][name="pivotdata"]');
if(h.length){f.find(".pt-throbber").show();if(a||c)var l=this._updateAjaxURL(a,c);l||d?(a=this.options.ajaxURL,c=this.options.timeout,d=b.ajaxS3,b.searchS3!==n&&(d=b.searchS3),f.find(".pt-empty").hide(),e.openRequest&&(e.openRequest.onreadystatechange=null,e.openRequest.abort()),e.openRequest=d({timeout:c,url:a,dataType:"json",type:"GET",success:function(a){e.openRequest=null;h.first().val(JSON.stringify(a));e.refresh()},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:
a.responseText)}})):e.refresh()}},_downloadXLS:function(){if(this.element.find('input[type="hidden"][name="pivotdata"]').length){var a=this._getOptions(),c=this._getFilters();a=this._updateAjaxURL(a,c,!0);a=this._setExtension(a,"xls");b.searchDownloadS3!==n?b.searchDownloadS3(a,"_blank"):window.open(a)}},_bindEvents:function(){var a=this,c=b(this.element),d=this.eventNamespace,e="#"+c.attr("id");b(e+"-options legend").on("click"+d,function(){b(this).siblings().toggle();b(this).children().toggle()});
b(e+"-filters legend").on("click"+d,function(){b(this).siblings().toggle();b(this).children().toggle()});b(".pt-hide-table",c).on("click"+d,function(){a.table_options.hidden=!0;b(".pt-table",c).hide();b(".pt-export-opt",c).hide();b(this).hide().siblings(".pt-show-table").show()});b(".pt-show-table",c).on("click"+d,function(){a.table_options.hidden=!1;b(".pt-table",c).show();b(".pt-export-opt",c).show();b(this).hide().siblings(".pt-hide-table").show()});b(".pt-export-xls",c).on("click"+d,function(){a._downloadXLS()});
b(e+"-totals").on("click"+d,function(){var c=b(this).is(":checked");a.options.showTotals!=c&&a.reload({totals:c},null,!1)});b(e+"-rows,"+e+"-cols,"+e+"-fact").on("change.autosubmit",function(){b(e+"-pt-form").trigger("optionChanged")});if(this.options.autoSubmit){var f=this.options.autoSubmit;b(e+"-pt-form").on("optionChanged",function(){var c=b(this);if(!c.data("noAutoSubmit")){var d=c.data("autoSubmitTimeout");d&&clearTimeout(d);d=setTimeout(function(){var b=a._getOptions(),c=a._getFilters();a.reload(b,
c,!1)},f);c.data("autoSubmitTimeout",d)}})}else b(e+"-pt-form input.pt-submit").on("click"+d,function(){var b=a._getOptions(),c=a._getFilters();a.reload(b,c,!1)});b(e+" .pt-table .pt-cell-zoom").on("click"+d,function(c){c=b(c.currentTarget).closest(".pt-cell");c.length&&a._cellExplore(c)});b(e+"-pchart-rows").on("click"+d,function(){a._renderChart({type:"piechart",axis:"rows"})});b(e+"-vchart-rows").on("click"+d,function(){a._renderChart({type:"barchart",axis:"rows"})});b(e+"-schart-rows").on("click"+
d,function(){a._renderChart({type:"spectrum",axis:"rows"})});b(e+"-hchart-rows").on("click"+d,function(){a._renderChart({type:"breakdown",axis:"rows"})});b(e+"-pchart-cols").on("click"+d,function(){a._renderChart({type:"piechart",axis:"cols"})});b(e+"-vchart-cols").on("click"+d,function(){a._renderChart({type:"barchart",axis:"cols"})});b(e+"-schart-cols").on("click"+d,function(){a._renderChart({type:"spectrum",axis:"cols"})});b(e+"-hchart-cols").on("click"+d,function(){a._renderChart({type:"breakdown",
axis:"cols"})});b(".pt-hide-chart",c).on("click"+d,function(){a._renderChart(!1)})},_unbindEvents:function(){var a=b(this.element),c="#"+a.attr("id"),d=this.eventNamespace;b(c+" .pt-table .pt-cell-zoom").off(d);b(c+"-options legend").off(d);b(c+"-filters legend").off(d);b(c+"-totals").off(d);b(c+"-rows,"+c+"-cols,"+c+"-fact").off("change.autosubmit");b(c+"-pt-form").off("optionChanged");b("input.pt-submit, .pt-export-xls",a).off(d);b(c+"-pchart-rows,"+c+"-vchart-rows,"+c+"-schart-rows,"+c+"-hchart-rows,"+
c+"-pchart-cols,"+c+"-vchart-cols,"+c+"-schart-cols,"+c+"-hchart-cols").off(d);b(".pt-hide-table, .pt-show-table, .pt-hide-chart",a).off(d)}})})(jQuery);
