/*
 2018-2020 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(b){var g=0;return function(){return g<b.length?{done:!1,value:b[g++]}:{done:!0}}};$jscomp.arrayIterator=function(b){return{next:$jscomp.arrayIteratorImpl(b)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,g,e){if(b==Array.prototype||b==Object.prototype)return b;b[g]=e.value;return b};$jscomp.getGlobal=function(b){b=["object"==typeof globalThis&&globalThis,b,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var g=0;g<b.length;++g){var e=b[g];if(e&&e.Math==Math)return e}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(b,g){var e=$jscomp.propertyToPolyfillSymbol[g];if(null==e)return b[g];e=b[e];return void 0!==e?e:b[g]};
$jscomp.polyfill=function(b,g,e,h){g&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(b,g,e,h):$jscomp.polyfillUnisolated(b,g,e,h))};$jscomp.polyfillUnisolated=function(b,g,e,h){e=$jscomp.global;b=b.split(".");for(h=0;h<b.length-1;h++){var a=b[h];if(!(a in e))return;e=e[a]}b=b[b.length-1];h=e[b];g=g(h);g!=h&&null!=g&&$jscomp.defineProperty(e,b,{configurable:!0,writable:!0,value:g})};
$jscomp.polyfillIsolated=function(b,g,e,h){var a=b.split(".");b=1===a.length;h=a[0];h=!b&&h in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var c=0;c<a.length-1;c++){var d=a[c];if(!(d in h))return;h=h[d]}a=a[a.length-1];e=$jscomp.IS_SYMBOL_NATIVE&&"es6"===e?h[a]:null;g=g(e);null!=g&&(b?$jscomp.defineProperty($jscomp.polyfills,a,{configurable:!0,writable:!0,value:g}):g!==e&&($jscomp.propertyToPolyfillSymbol[a]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(a):$jscomp.POLYFILL_PREFIX+a,a=
$jscomp.propertyToPolyfillSymbol[a],$jscomp.defineProperty(h,a,{configurable:!0,writable:!0,value:g})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(b){if(b)return b;var g=function(a,c){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:c})};g.prototype.toString=function(){return this.$jscomp$symbol$id_};var e=0,h=function(a){if(this instanceof h)throw new TypeError("Symbol is not a constructor");return new g("jscomp_symbol_"+(a||"")+"_"+e++,a)};return h},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(b){if(b)return b;b=Symbol("Symbol.iterator");for(var g="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),e=0;e<g.length;e++){var h=$jscomp.global[g[e]];"function"===typeof h&&"function"!=typeof h.prototype[b]&&$jscomp.defineProperty(h.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return b},"es6",
"es3");$jscomp.iteratorPrototype=function(b){b={next:b};b[Symbol.iterator]=function(){return this};return b};$jscomp.iteratorFromArray=function(b,g){b instanceof String&&(b+="");var e=0,h=!1,a={next:function(){if(!h&&e<b.length){var c=e++;return{value:g(c,b[c]),done:!1}}h=!0;return{done:!0,value:void 0}}};a[Symbol.iterator]=function(){return a};return a};$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(g){return g})}},"es6","es3");
(function(b,g){var e={rm_Add:"Add",rm_Cancel:"Cancel",rm_ConfirmDeleteAssignment:"Do you want to remove this assignment?",rm_Delete:"Delete",rm_DeletionFailed:"Deletion Failed",rm_ForEntity:"For Entity",rm_Role:"Role",rm_SubmissionFailed:"Submission Failed",rm_User:"User"},h=0;b.widget("s3.roleManager",{options:{mode:"roles",items:{},useRealms:!1,realmTypes:null,realms:null,ajaxURL:null},_create:function(){this.id=h;h+=1;this.eventNamespace=".roleManager"},_init:function(){for(var a in e)e[a]=i18n[a]||
e[a];this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){var a=b(this.element);this._unbindEvents();b(".rm-assign",a).remove();this.itemSelector=this.realmSelector=this.addButton=this.addRow=null;this._deserialize();a.append(this._assignmentTable());this._bindEvents()},_deserialize:function(){var a=b(this.element).attr("id"),c=b("#"+a+"-data").val();try{this.assignments=JSON.parse(c)}catch(d){this.assignments=[]}this.recordID=b("#"+a+"-id").val()},_serialize:function(){var a=
b(this.element).attr("id");b("#"+a+"-data").val(JSON.stringify(this.assignments))},_assignmentTable:function(){var a=this.options,c=b('<table class="rm-assign">');c.append(this._assignmentTableHead()).append(this._assignmentTableBody());if(a.ajaxURL){a=a.items;var d=!1,f;for(f in a)if(!1!==a[f].a){d=!0;break}d&&c.append(this._assignmentTableFooter())}return c},_assignmentTableHead:function(){var a=this.options,c=b("<thead>"),d=b("<tr>").appendTo(c);var f="users"==a.mode?e.rm_User:e.rm_Role;b("<th>").text(f).appendTo(d);
a.useRealms&&b("<th>").text(e.rm_ForEntity).appendTo(d);b("<th>").appendTo(d);return c},_assignmentTableBody:function(){var a=b("<tbody>"),c=this.assignments,d=this;c.length||a.append("<tr>");c.sort(function(f,l){return d._compareAssignments(f,l)}).forEach(function(f){a.append(d._assignmentTableRow(f))});return a},_assignmentTableRow:function(a){var c=b('<tr class="rm-assignment">').data("assignment",a),d=this.options,f=d.items[a[0]],l=b("<td>").appendTo(c);b('<span class="rm-item-name">').text(f.l).appendTo(l);
f.t&&b('<span class="rm-item-title">').text(f.t).appendTo(l);d.useRealms&&(a=!f.u&&d.realms[a[1]].l||"",b("<td>").text(a).appendTo(c));a=b("<td>");!1!==f.r&&d.ajaxURL&&(d=b('<span class="rm-delete-assignment delete-btn-ajax">'),a.append(d.text(e.rm_Delete)));return c.append(a)},_assignmentTableFooter:function(){var a=b("<tfoot>"),c=b("<tr>").appendTo(a);b("<td>").append(this._itemSelector()).appendTo(c);this.options.useRealms&&b("<td>").append(this._realmSelector()).appendTo(c);var d=b('<a class="rm-submit-add action-btn">').text(e.rm_Add),
f=b('<span class="rm-cancel-add action-lnk">').text(e.rm_Cancel);d.prop("disabled",!0).attr("disabled","disabled");b('<td class="rm-row-actions">').append(d).append(f).appendTo(c);this.addRow=c;return a},_itemSelector:function(){var a=b('<select class="rm-item-select">'),c=this.options.items,d=[];b('<option value="">').prop("selected",!0).prop("disabled",!0).hide().appendTo(a);var f;for(f in c){var l=c[f];if(!1!==l.a){var m=l.l;l.t&&(m+=" ("+l.t+")");d.push([f,m])}}d.sort(function(k,n){return k[1]!==
n[1]&&(k[1]>n[1]&&1||-1)||0}).forEach(function(k){b("<option>").attr("value",k[0]).text(k[1]).appendTo(a)});return this.itemSelector=a},_realmSelector:function(){var a=b('<select class="rm-realm-select">'),c=this.options,d=c.realms,f=this,l={};Object.keys(d).sort(function(m,k){return f._compareRealms(m,k)}).forEach(function(m){var k=d[m],n=k.t;m=[m,k.l];k=l[n];k===g?l[n]=[m]:k.push(m)});b('<option value="">').prop("selected",!0).prop("disabled",!0).hide().appendTo(a);c.realmTypes.forEach(function(m){var k=
l[m[0]];if(k){var n=b("<optgroup>").attr("label",m[1]).appendTo(a);k.forEach(function(p){b("<option>").attr("value",p[0]).text(p[1]).appendTo(n)})}});this.realmSelector=a;this._resetRealmSelector();return a.prop("disabled",!0).css({visibility:"hidden"})},_toggleAdd:function(a){var c=b(".rm-submit-add",this.addRow);c.length&&(a?c.prop("disabled",!1).removeAttr("disabled"):c.prop("disabled",!0).attr("disabled","disabled"))},_resetAddRow:function(){var a=b(".rm-item-select",this.addRow);a.length&&a.val("").change();
this._checkNewAssignment()},_resetRealmSelector:function(){var a=this.realmSelector;a&&(b('option[value="null"]',a).length?a.val("null"):a.val(""))},_optionSelected:function(){var a=this.options,c=this.itemSelector,d=this.realmSelector;if(c!==g)if(c=c.val()){if(a=a.items[c])d&&(a.u?(this._resetRealmSelector(),d.prop("disabled",!0).css({visibility:"hidden"})):d.prop("disabled",!1).css({visibility:"visible"})),!1===this._checkNewAssignment()?this._toggleAdd(!1):this._toggleAdd(!0)}else d&&(this._resetRealmSelector(),
d.prop("disabled",!0).css({visibility:"hidden"})),this._toggleAdd(!1)},_realmSelected:function(){!1===this._checkNewAssignment()?this._toggleAdd(!1):this._toggleAdd(!0)},_getNewAssignment:function(){var a=this.itemSelector;if(a){var c=null;if((a=a.val())&&!isNaN(a-0))return this.options.useRealms&&(c=this.realmSelector.val(),null!==c&&(c-=0,isNaN(c)&&(c=null))),[a-0,c]}},_checkNewAssignment:function(){var a=this._getNewAssignment(),c=b(".rm-assignment",b(this.element)).removeClass("rm-duplicate");
if(a){for(var d=c.length;d--;){var f=b(c[d]),l=f.data("assignment");if(a[0]===l[0]&&a[1]===l[1])return f.addClass("rm-duplicate"),!1}return a}},_addAssignment:function(){var a=this.options.ajaxURL,c=this._checkNewAssignment();if(a&&c){var d=this.addRow,f=b(".rm-submit-add",d).hide(),l=b(".rm-cancel-add",d).hide(),m=b('<div class="inline-throbber">').insertBefore(f),k=this;b.ajaxS3({type:"POST",url:a.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({add:[c]}),dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",
success:function(){k.assignments.push(c);k._serialize();for(var n=b(".rm-assignment",b(k.element)),p=k._assignmentTableRow(c).hide(),q=n.length;q--;){var r=b(n[q]),t=r.data("assignment");if(-1==k._compareAssignments(t,c)){p.insertAfter(r).fadeIn();p=null;break}}p&&(b("tbody",d.closest(".rm-assign")).prepend(p),p.fadeIn());m.remove();f.show();l.show();k._resetAddRow()},error:function(){var n=b('<span class="rm-error">').insertBefore(m.hide());n.text(e.rm_SubmissionFailed);m.remove();window.setTimeout(function(){n.fadeOut(function(){f.show();
l.show()})},1E3)}})}},_deleteAssignment:function(a){var c=this.options,d=c.ajaxURL,f=a.data("assignment");if(d&&f){var l=e.rm_ConfirmDeleteAssignment;l=l.replace(/%\((role|user)\)s/g,'"'+c.items[f[0]].l+'"');if(confirm(l)){var m=b(".rm-delete-assignment",a).hide(),k=b('<div class="inline-throbber">').insertBefore(m),n=this;b.ajaxS3({type:"POST",url:d.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({remove:[f]}),dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",success:function(){n.assignments=
n.assignments.filter(function(p){return p[0]!==f[0]||p[1]!==f[1]});n._serialize();b(".rm-assignment",b(n.element)).each(function(){var p=b(this).data("assignment");p[0]===f[0]&&p[1]===f[1]&&b(this).fadeOut(function(){k.remove();b(this).remove();n._checkNewAssignment()&&n._toggleAdd(!0)})})},error:function(){var p=b('<span class="rm-error">').insertBefore(k.hide());p.text(e.rm_DeletionFailed);k.remove();window.setTimeout(function(){p.fadeOut(function(){m.show()})},1E3)}})}}},_compareAssignments:function(a,
c){var d=this.options.items,f=d[a[0]].l;d=d[c[0]].l;return f==d?this._compareRealms(a[1],c[1]):f>d&&1||-1},_compareRealms:function(a,c){if(a===c)return 0;var d=this.options.realms,f=this._compareRealmTypes(d[a].t,d[c].t);return f?f:a?c?d[a].l>d[c].l&&1||-1:-1:null===a&&1||null===c&&-1||1},_compareRealmTypes:function(a,c){if(a===c)return 0;var d=this.options.realmTypes.map(function(f){return f[0]});a=d.indexOf(a);c=d.indexOf(c);return a-c},_bindEvents:function(){var a=this.eventNamespace,c=this;if(this.addRow!==
g)this.addRow.on("change"+a,".rm-item-select",function(){c._optionSelected()}).on("change"+a,".rm-realm-select",function(){c._realmSelected()}).on("click"+a,".rm-cancel-add",function(){c._resetAddRow()}).on("click"+a,".rm-submit-add",function(){c._addAssignment()});b(this.element).on("click"+a,".rm-delete-assignment",function(){c._deleteAssignment(b(this).closest(".rm-assignment"))});return!0},_unbindEvents:function(){var a=b(this.element),c=this.eventNamespace;this.addRow!==g&&this.addRow.off(c);
a.off(c);return!0}})})(jQuery);
