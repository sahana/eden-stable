/*
 2018-2020 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var e=0;return function(){return e<a.length?{done:!1,value:a[e++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,e,d){if(a==Array.prototype||a==Object.prototype)return a;a[e]=d.value;return a};$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var e=0;e<a.length;++e){var d=a[e];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,e){var d=$jscomp.propertyToPolyfillSymbol[e];if(null==d)return a[e];d=a[d];return void 0!==d?d:a[e]};
$jscomp.polyfill=function(a,e,d,f){e&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,e,d,f):$jscomp.polyfillUnisolated(a,e,d,f))};$jscomp.polyfillUnisolated=function(a,e,d,f){d=$jscomp.global;a=a.split(".");for(f=0;f<a.length-1;f++){var b=a[f];b in d||(d[b]={});d=d[b]}a=a[a.length-1];f=d[a];e=e(f);e!=f&&null!=e&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:e})};
$jscomp.polyfillIsolated=function(a,e,d,f){var b=a.split(".");a=1===b.length;f=b[0];f=!a&&f in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var c=0;c<b.length-1;c++){var g=b[c];g in f||(f[g]={});f=f[g]}b=b[b.length-1];d=$jscomp.IS_SYMBOL_NATIVE&&"es6"===d?f[b]:null;e=e(d);null!=e&&(a?$jscomp.defineProperty($jscomp.polyfills,b,{configurable:!0,writable:!0,value:e}):e!==d&&($jscomp.propertyToPolyfillSymbol[b]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(b):$jscomp.POLYFILL_PREFIX+b,b=$jscomp.propertyToPolyfillSymbol[b],
$jscomp.defineProperty(f,b,{configurable:!0,writable:!0,value:e})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(a){if(a)return a;var e=function(b,a){this.$jscomp$symbol$id_=b;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:a})};e.prototype.toString=function(){return this.$jscomp$symbol$id_};var d=0,f=function(a){if(this instanceof f)throw new TypeError("Symbol is not a constructor");return new e("jscomp_symbol_"+(a||"")+"_"+d++,a)};return f},"es6","es3");$jscomp.initSymbolIterator=function(){};
$jscomp.polyfill("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var e="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),d=0;d<e.length;d++){var f=$jscomp.global[e[d]];"function"===typeof f&&"function"!=typeof f.prototype[a]&&$jscomp.defineProperty(f.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return a},"es6",
"es3");$jscomp.initSymbolAsyncIterator=function(){};$jscomp.iteratorPrototype=function(a){a={next:a};a[Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,e){a instanceof String&&(a+="");var d=0,f={next:function(){if(d<a.length){var b=d++;return{value:e(b,a[b]),done:!1}}f.next=function(){return{done:!0,value:void 0}};return f.next()}};f[Symbol.iterator]=function(){return f};return f};
$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
(function(a,e){var d={rm_Add:"Add",rm_Cancel:"Cancel",rm_ConfirmDeleteAssignment:"Do you want to remove this assignment?",rm_Delete:"Delete",rm_DeletionFailed:"Deletion Failed",rm_ForEntity:"For Entity",rm_Role:"Role",rm_SubmissionFailed:"Submission Failed",rm_User:"User"},f=0;a.widget("s3.roleManager",{options:{mode:"roles",items:{},useRealms:!1,realmTypes:null,realms:null,ajaxURL:null},_create:function(){this.id=f;f+=1;this.eventNamespace=".roleManager"},_init:function(){for(var a in d)d[a]=i18n[a]||
d[a];this.refresh()},_destroy:function(){a.Widget.prototype.destroy.call(this)},refresh:function(){var b=a(this.element);this._unbindEvents();a(".rm-assign",b).remove();this.itemSelector=this.realmSelector=this.addButton=this.addRow=null;this._deserialize();b.append(this._assignmentTable());this._bindEvents()},_deserialize:function(){var b=a(this.element).attr("id"),c=a("#"+b+"-data").val();try{this.assignments=JSON.parse(c)}catch(g){this.assignments=[]}this.recordID=a("#"+b+"-id").val()},_serialize:function(){var b=
a(this.element).attr("id");a("#"+b+"-data").val(JSON.stringify(this.assignments))},_assignmentTable:function(){var b=this.options,c=a('<table class="rm-assign">');c.append(this._assignmentTableHead()).append(this._assignmentTableBody());if(b.ajaxURL){b=b.items;var g=!1,d;for(d in b)if(!1!==b[d].a){g=!0;break}g&&c.append(this._assignmentTableFooter())}return c},_assignmentTableHead:function(){var b=this.options,c=a("<thead>"),g=a("<tr>").appendTo(c);var e="users"==b.mode?d.rm_User:d.rm_Role;a("<th>").text(e).appendTo(g);
b.useRealms&&a("<th>").text(d.rm_ForEntity).appendTo(g);a("<th>").appendTo(g);return c},_assignmentTableBody:function(){var b=a("<tbody>"),c=this.assignments,g=this;c.length||b.append("<tr>");c.sort(function(a,b){return g._compareAssignments(a,b)}).forEach(function(a){b.append(g._assignmentTableRow(a))});return b},_assignmentTableRow:function(b){var c=a('<tr class="rm-assignment">').data("assignment",b),g=this.options,e=g.items[b[0]],f=a("<td>").appendTo(c);a('<span class="rm-item-name">').text(e.l).appendTo(f);
e.t&&a('<span class="rm-item-title">').text(e.t).appendTo(f);g.useRealms&&(b=!e.u&&g.realms[b[1]].l||"",a("<td>").text(b).appendTo(c));b=a("<td>");!1!==e.r&&g.ajaxURL&&(g=a('<span class="rm-delete-assignment delete-btn-ajax">'),b.append(g.text(d.rm_Delete)));return c.append(b)},_assignmentTableFooter:function(){var b=a("<tfoot>"),c=a("<tr>").appendTo(b);a("<td>").append(this._itemSelector()).appendTo(c);this.options.useRealms&&a("<td>").append(this._realmSelector()).appendTo(c);var g=a('<a class="rm-submit-add action-btn">').text(d.rm_Add),
e=a('<span class="rm-cancel-add action-lnk">').text(d.rm_Cancel);g.prop("disabled",!0).attr("disabled","disabled");a('<td class="rm-row-actions">').append(g).append(e).appendTo(c);this.addRow=c;return b},_itemSelector:function(){var b=a('<select class="rm-item-select">'),c=this.options.items,g=[];a('<option value="">').prop("selected",!0).prop("disabled",!0).hide().appendTo(b);var e;for(e in c){var d=c[e];if(!1!==d.a){var f=d.l;d.t&&(f+=" ("+d.t+")");g.push([e,f])}}g.sort(function(a,b){return a[1]!==
b[1]&&(a[1]>b[1]&&1||-1)||0}).forEach(function(c){a("<option>").attr("value",c[0]).text(c[1]).appendTo(b)});return this.itemSelector=b},_realmSelector:function(){var b=a('<select class="rm-realm-select">'),c=this.options,g=c.realms,d=this,f={};Object.keys(g).sort(function(a,b){return d._compareRealms(a,b)}).forEach(function(a){var b=g[a],c=b.t;a=[a,b.l];b=f[c];b===e?f[c]=[a]:b.push(a)});a('<option value="">').prop("selected",!0).prop("disabled",!0).hide().appendTo(b);c.realmTypes.forEach(function(c){var g=
f[c[0]];if(g){var d=a("<optgroup>").attr("label",c[1]).appendTo(b);g.forEach(function(b){a("<option>").attr("value",b[0]).text(b[1]).appendTo(d)})}});this.realmSelector=b;this._resetRealmSelector();return b.prop("disabled",!0).css({visibility:"hidden"})},_toggleAdd:function(b){var c=a(".rm-submit-add",this.addRow);c.length&&(b?c.prop("disabled",!1).removeAttr("disabled"):c.prop("disabled",!0).attr("disabled","disabled"))},_resetAddRow:function(){var b=a(".rm-item-select",this.addRow);b.length&&b.val("").change();
this._checkNewAssignment()},_resetRealmSelector:function(){var b=this.realmSelector;b&&(a('option[value="null"]',b).length?b.val("null"):b.val(""))},_optionSelected:function(){var a=this.options,c=this.itemSelector,g=this.realmSelector;if(c!==e)if(c=c.val()){if(a=a.items[c])g&&(a.u?(this._resetRealmSelector(),g.prop("disabled",!0).css({visibility:"hidden"})):g.prop("disabled",!1).css({visibility:"visible"})),!1===this._checkNewAssignment()?this._toggleAdd(!1):this._toggleAdd(!0)}else g&&(this._resetRealmSelector(),
g.prop("disabled",!0).css({visibility:"hidden"})),this._toggleAdd(!1)},_realmSelected:function(){!1===this._checkNewAssignment()?this._toggleAdd(!1):this._toggleAdd(!0)},_getNewAssignment:function(){var a=this.itemSelector;if(a){var c=null;if((a=a.val())&&!isNaN(a-0))return this.options.useRealms&&(c=this.realmSelector.val(),null!==c&&(c-=0,isNaN(c)&&(c=null))),[a-0,c]}},_checkNewAssignment:function(){var b=this._getNewAssignment(),c=a(".rm-assignment",a(this.element)).removeClass("rm-duplicate");
if(b){for(var g=c.length;g--;){var d=a(c[g]),e=d.data("assignment");if(b[0]===e[0]&&b[1]===e[1])return d.addClass("rm-duplicate"),!1}return b}},_addAssignment:function(){var b=this.options.ajaxURL,c=this._checkNewAssignment();if(b&&c){var g=this.addRow,e=a(".rm-submit-add",g).hide(),f=a(".rm-cancel-add",g).hide(),l=a('<div class="inline-throbber">').insertBefore(e),h=this;a.ajaxS3({type:"POST",url:b.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({add:[c]}),dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",
success:function(){h.assignments.push(c);h._serialize();for(var b=a(".rm-assignment",a(h.element)),d=h._assignmentTableRow(c).hide(),n=b.length;n--;){var k=a(b[n]),p=k.data("assignment");if(-1==h._compareAssignments(p,c)){d.insertAfter(k).fadeIn();d=null;break}}d&&(a("tbody",g.closest(".rm-assign")).prepend(d),d.fadeIn());l.remove();e.show();f.show();h._resetAddRow()},error:function(){var b=a('<span class="rm-error">').insertBefore(l.hide());b.text(d.rm_SubmissionFailed);l.remove();window.setTimeout(function(){b.fadeOut(function(){e.show();
f.show()})},1E3)}})}},_deleteAssignment:function(b){var c=this.options,e=c.ajaxURL,f=b.data("assignment");if(e&&f){var k=d.rm_ConfirmDeleteAssignment;k=k.replace(/%\((role|user)\)s/g,'"'+c.items[f[0]].l+'"');if(confirm(k)){var l=a(".rm-delete-assignment",b).hide(),h=a('<div class="inline-throbber">').insertBefore(l),m=this;a.ajaxS3({type:"POST",url:e.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({remove:[f]}),dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",success:function(){m.assignments=
m.assignments.filter(function(a){return a[0]!==f[0]||a[1]!==f[1]});m._serialize();a(".rm-assignment",a(m.element)).each(function(){var b=a(this).data("assignment");b[0]===f[0]&&b[1]===f[1]&&a(this).fadeOut(function(){h.remove();a(this).remove();m._checkNewAssignment()&&m._toggleAdd(!0)})})},error:function(){var b=a('<span class="rm-error">').insertBefore(h.hide());b.text(d.rm_DeletionFailed);h.remove();window.setTimeout(function(){b.fadeOut(function(){l.show()})},1E3)}})}}},_compareAssignments:function(a,
c){var b=this.options.items,d=b[a[0]].l;b=b[c[0]].l;return d==b?this._compareRealms(a[1],c[1]):d>b&&1||-1},_compareRealms:function(a,c){if(a===c)return 0;var b=this.options.realms,d=this._compareRealmTypes(b[a].t,b[c].t);return d?d:a?c?b[a].l>b[c].l&&1||-1:-1:null===a&&1||null===c&&-1||1},_compareRealmTypes:function(a,c){if(a===c)return 0;var b=this.options.realmTypes.map(function(a){return a[0]});a=b.indexOf(a);c=b.indexOf(c);return a-c},_bindEvents:function(){var b=this.eventNamespace,c=this;if(this.addRow!==
e)this.addRow.on("change"+b,".rm-item-select",function(){c._optionSelected()}).on("change"+b,".rm-realm-select",function(){c._realmSelected()}).on("click"+b,".rm-cancel-add",function(){c._resetAddRow()}).on("click"+b,".rm-submit-add",function(){c._addAssignment()});a(this.element).on("click"+b,".rm-delete-assignment",function(){c._deleteAssignment(a(this).closest(".rm-assignment"))});return!0},_unbindEvents:function(){var b=a(this.element),c=this.eventNamespace;this.addRow!==e&&this.addRow.off(c);
b.off(c);return!0}})})(jQuery);
