/*
 2013-2020 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js

*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,e,d){b instanceof String&&(b=String(b));for(var a=b.length,c=0;c<a;c++){var f=b[c];if(e.call(d,f,c,b))return{i:c,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,e,d){if(b==Array.prototype||b==Object.prototype)return b;b[e]=d.value;return b};$jscomp.getGlobal=function(b){b=["object"==typeof globalThis&&globalThis,b,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var e=0;e<b.length;++e){var d=b[e];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(b,e){var d=$jscomp.propertyToPolyfillSymbol[e];if(null==d)return b[e];d=b[d];return void 0!==d?d:b[e]};
$jscomp.polyfill=function(b,e,d,a){e&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(b,e,d,a):$jscomp.polyfillUnisolated(b,e,d,a))};$jscomp.polyfillUnisolated=function(b,e,d,a){d=$jscomp.global;b=b.split(".");for(a=0;a<b.length-1;a++){var c=b[a];c in d||(d[c]={});d=d[c]}b=b[b.length-1];a=d[b];e=e(a);e!=a&&null!=e&&$jscomp.defineProperty(d,b,{configurable:!0,writable:!0,value:e})};
$jscomp.polyfillIsolated=function(b,e,d,a){var c=b.split(".");b=1===c.length;a=c[0];a=!b&&a in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<c.length-1;f++){var h=c[f];h in a||(a[h]={});a=a[h]}c=c[c.length-1];d=$jscomp.IS_SYMBOL_NATIVE&&"es6"===d?a[c]:null;e=e(d);null!=e&&(b?$jscomp.defineProperty($jscomp.polyfills,c,{configurable:!0,writable:!0,value:e}):e!==d&&($jscomp.propertyToPolyfillSymbol[c]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(c):$jscomp.POLYFILL_PREFIX+c,c=$jscomp.propertyToPolyfillSymbol[c],
$jscomp.defineProperty(a,c,{configurable:!0,writable:!0,value:e})))};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,d){return $jscomp.findInternal(this,b,d).v}},"es6","es3");
(function(b,e){var d=0;b.widget("s3.timeplot",{options:{ajaxURL:null,autoSubmit:1E3,burnDown:!1,emptyMessage:"No data available",thousandSeparator:" ",thousandGrouping:"3",precision:null,defaultChartType:"linechart",defaultChartAxis:"totals"},_create:function(){this.id=d;d+=1},_init:function(){var a=b(this.element),c=this.options;this.widget_id=a.attr("id");this.input=a.find('input[type="hidden"][name="tp-data"]').first();this.svg=this.data=null;a=a.find(".tp-chart");this.chart=a.length?a.first():
null;this.currentChart={type:null,chart:null,container:null};c.numberFormatter=function(a){var b=c.precision;if(null===a||"undefined"==typeof a)return"-";b=b||0==b?a.toFixed(b):a.toString();b=b.split(".");a=b[0];b=1<b.length?"."+b[1]:"";a=a.replace(new RegExp("\\B(?=(\\d{"+c.thousandGrouping+"})+(?!\\d))","g"),c.thousandSeparator);return a+b};this.refresh()},_destroy:function(){var a=this.element;this._unbindEvents();this.svg&&(this.svg.remove(),this.svg=null,a.find(".tp-chart").empty());this.data=
null;b.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.element;this._unbindEvents();this._renderChart();this._renderChartOptions();this.options.autoSubmit?a.find(".tp-submit").hide():a.find(".tp-submit").show();this._bindEvents();a.find(".tp-throbber").hide()},_renderChartOptions:function(){var a=b(this.element),c=a.find(".tp-chart-controls").first().empty();if(!this.data.e){var f=a.attr("id");a=b('<div class="pt-chart-opts">');var h=f+"-bchart-totals";f+="-lchart-totals";b(a).append(b('<span id="'+
f+'" class="tp-chart-icon tp-lchart"/><span class="tp-chart-label">Line Chart</span>'));b(a).append(b('<span id="'+h+'" class="tp-chart-icon tp-bchart"/><span class="tp-chart-label">Bar Chart</span>'));b(c).append(a)}},_renderChart:function(a){var b=this.chart;if(b){var f=this.options,h=this.currentChart,g=null,d=null;a?(g=a.type,d=a.axis):(h&&(g=h.type,d=h.axis),g&&d||(g=f.defaultChartType,d=f.defaultChartAxis));h.type==g&&h.axis==d||this._removeChart();a=this.element;f=a.find(".tp-empty");h=this.data;
null===h&&(h=JSON.parse(this.input.val()));h||(h={e:!0});this.data=h;if(h.e)this._removeChart(),a.find(".tp-empty").show();else switch(f.hide(),b.show(),d){case "totals":switch(g){case "barchart":this._renderBarChart(b,h.f,h.p);break;default:this._renderLineChart(b,h.f,h.p)}}}},_removeChart:function(){var a=this.chart;a&&(a.empty().hide(),a=this.currentChart,a.container=null,a.chart=null,a.type=null,a.axis=null,b(window).off("resize.tp"))},_renderBarChart:function(a,c,f){var h=[];for(c=0;c<f.length;c++){var g=
f[c];h.push({start:(new Date(g.t[0])).getTime(),value:g.v[0]})}f=this.currentChart;if(f.chart){var d=f.container;var e=f.chart;d.datum([{key:"reportChart",values:h}]).transition().duration(500).call(e)}else b(a).closest(".tp-chart-contents").show().css({width:"96%"}),b(a).css({height:"360px"}),d=d3.select(b(a).get(0)).append("svg").attr("class","nv"),e=nv.models.discreteBarChart().x(function(a){return a.start}).y(function(a){return a.value}).color(["silver"]).staggerLabels(!0).showValues(!0).forceY([0,
1]),e.tooltip.enabled(!1),a=this.options.numberFormatter,e.valueFormat(a),e.yAxis.tickFormat(a),e.xAxis.tickFormat(function(a){return(new Date(a)).toLocaleDateString()}),nv.addGraph(function(){d.datum([{key:"reportChart",values:h}]).transition().duration(500).call(e);b(window).off("resize.tp").on("resize.tp",function(a){e.update(a)});return e}),f.container=d,f.chart=e,f.type="barchart",f.axis="totals"},_renderLineChart:function(a,c,f){var h=[],d={},e=0,t=1==c.length,l;for(l=0;l<c.length;l++){var n=
c[l][0];d.hasOwnProperty(n)&&(e=d[n]+1);(d[n]=e)&&(n+=" ["+(e+1)+"]");var p={key:n,label:c[l][0],area:t},u=[];for(n=0;n<f.length;n++){var m=f[n];u.push({start:(new Date(m.t[0])).getTime(),value:m.v[l]})}p.values=u;h.push(p)}c=this.currentChart;if(c.chart){var k=c.container;var q=c.chart;k.datum(h).transition().duration(250).call(q)}else b(a).closest(".tp-chart-contents").show().css({width:"96%"}),b(a).css({height:"360px"}),k=d3.select(b(a).get(0)).append("svg").attr("class","nv"),q=nv.models.lineChart().x(function(a){return a.start}).y(function(a){return a.value}).margin({right:50}).duration(250).showLegend(!0).useInteractiveGuideline(!0).forceY([0,
1]),q.yAxis.tickFormat(this.options.numberFormatter),q.xAxis.tickFormat(function(a){return(new Date(a)).toLocaleDateString()}),nv.addGraph(function(){k.datum(h).transition().duration(500).call(q);b(window).off("resize.tp").on("resize.tp",function(a){q.update(a)});return q}),c.container=k,c.chart=q,c.type="linechart",c.axis="totals"},reload:function(a,c,f){f="undefined"!=typeof f?f:!0;"undefined"==typeof c&&(c=this._getFilters());var d=this,g=!1;b(this.element).find(".tp-throbber").show();if(a||c)g=
this._updateAjaxURL(a,c);g||f?(a=this.options.ajaxURL,c=b.ajaxS3,b.searchS3!==e&&(c=b.searchS3),c({url:a,type:"GET",dataType:"json",success:function(a){d.input.val(JSON.stringify(a));d.data=a;d.refresh()},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})):d.refresh()},_getOptions:function(){var a="#"+b(this.element).attr("id"),c=b(a+"-time").val(),d=a=null,e=null;"custom"!=c&&(c=c.split("|"),3==c.length&&(a=c[0],d=c[1],e=c[2]));return{start:a,end:d,slots:e}},
_getFilters:function(){var a=b("#"+this.widget_id+"-filters");try{return a.length?S3.search.getCurrentFilters(a.first()):null}catch(c){return null}},_updateAjaxURL:function(a,c){var d=this.options.ajaxURL;if(!d)return!1;var e=d.split("?");if(1<e.length){var g=e[1];var r=g.split("&")}else g="",r=[];var t=[];d=!1;if(a)for(var l in a)g=a[l],g=l+"="+g,d||-1!=b.inArray(g,r)||(d=!0),t.push(g);l={};var n={},p;if(c){var u=function(a){var b,c,d=[];["contains","anyof","belongs","eq"].forEach(function(e){b=
new RegExp("__"+e+"$","g");a.match(b)?c=b:d.push(e)});c&&d.forEach(function(b){n[a.replace(c,"__"+b)]=!0})};g=0;for(p=c.length;g<p;g++){var m=c[g];var k=m[0];m=m[1];u(k);null===m?l[k]||(n[k]=!0):(n[k]&&(n[k]=!1),m=k+"="+encodeURIComponent(m),l[k]?l[k].push(m):l[k]=[m])}}g=0;for(p=r.length;g<p;g++)m=r[g].split("="),1<m.length&&(k=decodeURIComponent(m[0]),m=decodeURIComponent(m[1]),n[k]?d=!0:l[k]?d||-1!=b.inArray(k+"="+m,l[k])||(d=!0):a&&a.hasOwnProperty(k)||t.push(r[g]));for(k in l)for(g=0,p=l[k].length;g<
p;g++)d||-1!=b.inArray(l[k][g],r)||(d=!0),t.push(l[k][g]);a=t.join("&");c=e[0];a&&(c=c+"?"+a);this.options.ajaxURL=c;return d},_parseDate:function(a){return d3.time.format("%Y-%m-%dT%H:%M:%S+00:00").parse(a)},_bindEvents:function(){var a=this,c="#"+this.widget_id;b(c+"-options legend").click(function(){b(this).siblings().toggle();b(this).children().toggle()});b(c+"-filters legend").click(function(){b(this).siblings().toggle();b(this).children().toggle()});b(c+"-time").on("change.autosubmit",function(){b(c+
"-tp-form").trigger("optionChanged")});if(this.options.autoSubmit){var d=this.options.autoSubmit;b(c+"-tp-form").on("optionChanged",function(){var c=b(this);if(!c.data("noAutoSubmit")){var e=c.data("autoSubmitTimeout");e&&clearTimeout(e);e=setTimeout(function(){var b=a._getOptions(),c=a._getFilters();a.reload(b,c,!1)},d);c.data("autoSubmitTimeout",e)}})}else b(c+"-tp-form input.tp-submit").on("click.timeplot",function(){var b=a._getOptions(),c=a._getFilters();a.reload(b,c,!1)});b(c+"-lchart-totals").click(function(){a._renderChart({type:"linechart",
axis:"totals"})});b(c+"-bchart-totals").click(function(){a._renderChart({type:"barchart",axis:"totals"})})},_unbindEvents:function(){var a="#"+this.widget_id;b(window).off("resize.timeplot");b(a+"-tp-form").off("optionChanged");b(a+"-tp-form input.tp-submit").off("click.timeplot");b(a+"-time").unbind("change.autosubmit");b(a+"-options legend").unbind("click");b(a+"-filters legend").unbind("click");b(a+"-lchart-totals,"+a+"-bchart-totals").unbind("click")}})})(jQuery);
